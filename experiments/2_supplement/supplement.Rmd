---
title: Supplementary Content
subtitle: ??????Insert ms title???????
author: "Owen L Petchey, Rainer Krug, Marcel Suleiman, Romana Limberger, ???others???"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = TRUE)
```

```{r echo = FALSE}
rm(list = ls())
library(tidyverse)
library(microxanox)
library(patchwork)
library(here)
source(here("r", "various_useful_functions.r"))
# source(here("experiments", "1_figures_main_ms", "ms_figure_functions.r"))
source(here("experiments", "1_figures_main_ms", "figures_main_ms_v1.R"))

#print(fig_div_vs_o2diff_1strain_7row)

colfunc_CB <- colorRampPalette(c("#024F17", "#B5FFC9"))
colfunc_SB <- colorRampPalette(c("#7D1402", "#FCBEB3"))
colfunc_PB <- colorRampPalette(c("#6E0172", "#F9AEFC"))
zero <- 0
unity <- 1
```

# Introduction

This document contains the Supplementary Content for the report *?????????????*.

# Creating among strain diversity

Here we provide additional description of the method used to create strain variation within functional groups. The following should be read only after the relevant sections of the main text.

Take for example the cyanobacteria functional group, a reference maximum growth rate parameter $G_{max,CB}$ and a reference tolerance parameter $h_{SR,CB}$. Recall that amount of among strain variation is controlled by the two meta-parameters $Div_{G_{max,CB}}$ and $Div_{h_{SR,CB}}$. To create a tradeoff, the two meta-parameters were always of different sign. The among strain variation was calculated such that the growth rate of strain $i = 1$ was a factor $1/({2Div_{G_{max,CB}}})$ of the reference growth rate, and the growth rate of the $i = n$ strain was a factor $2Div_{G_{max,CB}}$ of the reference growth rate. The growth rate of the $i = {2,...n-1}$ other strains was the reference growth rate multiplied by a factor that was equally distributed between the factor of the $i = 1$ and $i = n$ strain. This implementation of the variation and trade-off has the assumption of a linear trade-off of log-log transformed among-strain variation. Hence, for example, with the reference growth rate $G_{max,CB} = 0.05$, among strain variation of $Div_{G_{max,CB}} = 1$, and nine strains ($n = 9$), the growth rates of the nine strains are 0.025, 0.03, 0.035, 0.042, 0.05, 0.059, 0.071, 0.084, 0.1. Put another way, the growth rate parameter of the $i$-th of the $n$ strains in a functional group was calculated as $G_{max,i} = D_i * G_{max}$ where $D_i$ is the $i$-th element of the set $D = {2f(x)Div_{G_{max}} |x ∈ N, x ≤ n}$, where $f(x) = (x − (n + 1)/2)/((n − 1)/2)$.

This procedure ensures that the range of trait values is independent of the number of strains. When there were only two strains, the two strains took the minimum and maximum traits values, as defined by the $Div$ variable for that trait. When there were three strains, one had the minimum trait value, one the maximum, and one the mean. With nine strains, one had the minimum trait value, one the maximum, one the mean, and three were equally spaced (on log scale) between the minimum and the mean, and the remaining three between the maximum and the mean.

We show three examples of the created variation among strains within functional groups, one for nine strains (Figure \@ref(fig:nine-strain-div)), one for three (Figure \@ref(fig:three-strain-div)), and one for two (Figure \@ref(fig:two-strain-div)). In each, three graphs shows the diversity among strains in the maximum growth rate trait and the tolerance trait, plotted against each other and therefore also showing the tradeoff between the two traits.

Notice that in all three cases, the range of trait variation represented by the strains is the same, even though the number of strains differs. This approach allowed us to independently manipulate trait diversity and number of strains. Also note that maximum growth rate of strains is evenly distributed on a log scale, even though it may appear at first site that they are distributed evenly on a linear scale (e.g. Figure \@ref(fig:three-strain-div)).

```{r  echo = FALSE}
CB_var_multiplier <- 2
SBPB_var_multiplier <- 6
CB_gmax_div <- 0.015789474 * CB_var_multiplier
CB_h_div <- -0.08 * CB_var_multiplier
SB_gmax_div <- 0.015789474 * SBPB_var_multiplier
SB_h_div <- -0.323  * SBPB_var_multiplier
PB_gmax_div <- 0.015789474  * SBPB_var_multiplier
PB_h_div <- -0.323  * SBPB_var_multiplier
num_div_treatment_levels <- 2
```

All three examples have the following amounts of trait variation: $Div_{G_{max,CB}}$ = `r round(CB_gmax_div, 3)`, $Div_{h_{SR,CB}}$ = `r round(CB_h_div, 3)`, $Div_{G_{max,SB}}$ = `r round(SB_gmax_div, 3)`, $Div_{h_{O,SB}}$ = `r round(SB_h_div, 3)`, $Div_{G_{max,PB}}$ = `r round(PB_gmax_div, 3)`, $Div_{h_{O,PB}}$ = `r round(PB_h_div, 3)`. These are also the maximum amounts of trait variation explored in the simulations.

(ref:nine-strain-div) Trait variation with nine strains in each of the functional groups. In all panels colour indicates the functional group, darker shades show more tolerant-lower growth rate strains, lighter shades show less tolerant-higher growth rate strains.

```{r nine-strain-div, echo = FALSE,  include=TRUE, fig.cap='(ref:nine-strain-div)', fig.align="center", fig.height=3, fig.width=8}

num_CB_strains <- 9
num_PB_strains <- 9
num_SB_strains <- 9
var_expt <- create_diversity_factorial(
  zero = zero, unity = unity,
  num_div_treatment_levels = num_div_treatment_levels,
  CB_gmax_div = CB_gmax_div, CB_h_div = CB_h_div,
  SB_gmax_div = SB_gmax_div, SB_h_div = SB_h_div,
  PB_gmax_div = PB_gmax_div, PB_h_div = PB_h_div,
  default_9strain = new_strain_parameter(
    n_CB = num_CB_strains,
    n_SB = num_SB_strains,
    n_PB = num_PB_strains,
    values_initial_state =  "bush_ssfig3"
  )
)
display_diversity(4,
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains,
  which_graphs = 1
)
```


(ref:three-strain-div) Trait variation with three strains in each of the functional groups. Note that the three displayed strains are the 1st, 5th, and 9th strains from the nine strain example shown in Figure \@ref(fig:nine-strain-div). In all panels colour indicates the functional group, darker shades show more tolerant-lower growth rate strains, lighter shades show less tolerant-higher growth rate strains.

```{r three-strain-div, echo = FALSE,  include=TRUE, fig.cap='(ref:three-strain-div)', fig.height=3, fig.width=8, fig.align="center"}

num_CB_strains <- 3
num_PB_strains <- 3
num_SB_strains <- 3
var_expt <- create_diversity_factorial(
  zero = zero, unity = unity,
  num_div_treatment_levels = num_div_treatment_levels,
  CB_gmax_div = CB_gmax_div, CB_h_div = CB_h_div,
  SB_gmax_div = SB_gmax_div, SB_h_div = SB_h_div,
  PB_gmax_div = PB_gmax_div, PB_h_div = PB_h_div,
  default_9strain = new_strain_parameter(
    n_CB = num_CB_strains,
    n_SB = num_SB_strains,
    n_PB = num_PB_strains,
    values_initial_state =  "bush_ssfig3"
  )
)
display_diversity(4,
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains,
  which_graphs = 1
)


#0.05*2^(CB_gmax_div) - 0.05
#0.05 - 0.05*2^(-CB_gmax_div)


```



(ref:two-strain-div) Trait variation with two strains in each of the functional groups. Note that the two displayed strains are the 1st and 9th strains from the nine strain example shown in Figure \@ref(fig:nine-strain-div). In all panels colour indicates the functional group, darker shades show more tolerant-lower growth rate strains, lighter shades show less tolerant-higher growth rate strains.

```{r two-strain-div, echo = FALSE,  include=TRUE, fig.cap='(ref:two-strain-div)', fig.height=3, fig.width=8, fig.align="center"}

num_CB_strains <- 2
num_PB_strains <- 2
num_SB_strains <- 2
var_expt <- create_diversity_factorial(
  zero = zero, unity = unity,
  num_div_treatment_levels = num_div_treatment_levels,
  CB_gmax_div = CB_gmax_div, CB_h_div = CB_h_div,
  SB_gmax_div = SB_gmax_div, SB_h_div = SB_h_div,
  PB_gmax_div = PB_gmax_div, PB_h_div = PB_h_div,
  default_9strain = new_strain_parameter(
    n_CB = num_CB_strains,
    n_SB = num_SB_strains,
    n_PB = num_PB_strains,
    values_initial_state =  "bush_ssfig3"
  )
)
display_diversity(4,
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains,
  which_graphs = 1
)
```

A consequence of this variation and of the tradeoffs is shown in  Figure \@ref(fig:growth-rates), which shows the relationship between realised growth rate and the concentration of the respective inhibiting substance, e.g. sulfide for the cyanobacteria. In these graphs only the least and most tolerant strains are shown. The lines cross due to the tradeoff. At high concentrations of the inhibiting substance the more tolerant strain has higher realised growth rate, while at lower concentrations it is the less tolerant strain that has the higher realised growth rate.

(ref:growth-rates) Response of realised growth rate to variation in concentration of the inhibiting substrate for two strains, namely the most and the least tolerant strain. As always colour indicates the functional group, darker shades show more tolerant-lower growth rate strains, lighter shades show less tolerant-higher growth rate strains.

```{r growth-rates, echo = FALSE,  include=TRUE, fig.cap='(ref:growth-rates)', fig.height=3, fig.width=8, fig.align="center"}
display_diversity(4,
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains,
  which_graphs = 2
)
```


# Method for finding stable states

## General method

We now discuss two approaches for finding how the stable state of the system varies along the gradient of oxygen diffusivity when there exists the possibility of multiple stable states. In the main article we describe and report results of the method that we term the *Temporal method*.

Here we also describe and give results of what we term the *Replication method*. In this, we made a separate simulations for each of many values of oxygen diffusivity, ran the simulations for long enough to ensure transients had passed, and recorded the state. We ran multiple simulations per value of oxygen diffusivity, and started them with different initial conditions (either low or high total cyanobacterial abundance), so as to check for presence of alternate stable states. This method used by [Bush et al 2017](https://www.nature.com/articles/s41467-017-00912-x). We term it the replication method since it is achieved by having many independent replicates of the ecosystem, each with a different oxygen diffusivity, and also a separate replicate for each of the different chosen initial conditions.

As is shown in the figures below, the temporal method results in a larger region of bistability than the replication method, but only during increasing oxygen diffusivities. The difference in results occurs because, as mentioned above, the initial conditions differ between the two approaches.

### Replication method, no diversity


```{r repl-meth1, echo=FALSE, eval = TRUE}
repl_meth <- readRDS(here("data", "0_ss_finding", "replication_method", "ss_data_9strains_sim_length1e+06_event_definition_2.RDS"))
temp_meth <- readRDS(here("data", "0_ss_finding", "temporal_method", "ss_data_9strains_waittime1e+06_event_definition_2.RDS"))
```



(ref:repl-meth2) Stable states found with the **replication method**. The right column of panels refers to the stable state when oxygen diffusivity is at first high (favouring the oxic state). The left column refers to when oxygen diffusivity is at first low (favouring the anoxic state). Points (which sometimes are so close as to appear as thick lines) show the stable state at the end of each period of constant oxygen diffusivity. Thin lines are for visualisation only, and join the points. Grey arrows show the oxygen diffusivity at which the system flips, and the direction of the flip. The length of the grey arrows is without meaning.

```{r repl-meth2, echo = FALSE,  include=TRUE, fig.cap='(ref:repl-meth2)', fig.height=8, fig.width=8, fig.align="center"}
fig_state_vs_o2diff_sidebyside_dots(repl_meth[1,])
```

### Temporal method, no diversity

(ref:temp-meth2) Stable states found with the **temporal method**. All other aspects are the same as in Figure \@ref(fig:repl-meth2).

```{r temp-meth2, echo = FALSE,  include=TRUE, fig.cap='(ref:temp-meth2)', fig.height=8, fig.width=8, fig.align="center"}
fig_state_vs_o2diff_sidebyside_dots(temp_meth[1,])
```


### Both methods overlaid, no diversity


(ref:both-meth1) Stable states of the two methods overlaid, the temporal method with a dashed line, and the replication method with a solid line.

```{r both-meth1, echo = FALSE,  include=TRUE, fig.cap='(ref:both-meth1)', fig.height=8, fig.width=8, fig.align="center"}
repl_method_1 <- repl_meth$ss_res[[1]] %>%
     mutate(time = NA,
            direction = ifelse(initial_N_CB == 1, "up", "down")) %>%
  select(names(temp_meth$ssfind_result[[1]]))

ss_result1 <- repl_method_1
ss_result2 <- temp_meth$ssfind_result[[1]]

plot_ss_result6(repl_method_1,
                temp_meth$ssfind_result[[1]],
                xlims = c(-8, 0))
```



## Effect of diversity, replication method



### Overal effects of diversity

The replication method shows the same effects of functional diversity as those revealed by the temporal method (Figure \@ref(fig:div-repl-meth1)). Namely

-   Introducing functional diversity in all three functional groups increases the resilience of both the anoxic and oxic state.
-   Introducing functional diversity in only the cyanobacteria function group delays (with respect to the oxygen diffusivity it occurs at) the switch to the anoxic state as oxygen diffusivity is reduced, but has no effect on the oxygen diffusivity at which the anoxic to oxic transition occurs .
-   Introducing function diversity in only the sulfur bacteria delays (with respect to the oxygen diffusivity it occurs at) the switch from anoxic to oxic, and advances the switch from oxic to anoxic.

(ref:div-repl-meth1) **Replication method results.** **Left column of panels**: the effect of response trait diversity (y-axis) on the positions of the tipping points (anoxic to oxic in blue, oxic to anoxic in red), which determine the extent of the region of bistability (green shaded region) in the oxygen diffusivity gradient. The left-most region is anoxic only, the middle is oxic or anoxic depending on historical conditions, and the right-most is oxic only. The thick grey vertical lines at -8 and 0 on the x-axis show the extent of the oxygen diffusivity gradient investigated in the simulations. **Right column of panels**: The effect of diversity on resilience, with positive values on the y-axis indicating that diversity has increased resilience, i.e. delayed the shift to the other state.

```{r div-repl-meth1, echo = FALSE,  include=TRUE, fig.cap='(ref:div-repl-meth1)', fig.height=8, fig.width=8, fig.align="center"}
all_stab <- readRDS(here("data", "0_ss_finding", "replication_method", "processed_data", "stab_data_replication_method.RDS"))

sim_length <- 1e6
num_strains <- 9
plot_here <- all_stab %>%
  filter(simlength == sim_length)
p1 <- fig_div_vs_o2diff_1strain_7row(plot_here,
                                     which_strain = num_strains,
                                     figure_title = paste0(sim_length,
                                                           " sim. length,\n",
                                                           num_strains,
                                                           " strains"))
p2 <- fig_resilience_vs_div(plot_here,
                            which_strain = num_strains,
                            figure_title = " ")
p1 + p2

```

### An example of stable states

Figure \@ref(fig:repl-meth-ex1) shows an example of stable states along the oxygen diffusivity gradient produced by the replication method for finding stable states. The patterns are similar to those produced by the temporal method for finding the stable states (see Figure 3 in the main report), though differ in one respect: some of the more tolerant strains occur in the stable states found by the temporal method (Figure 3 in the main report), while they do not occur in stable states found by the replication method (Figure \@ref(fig:repl-meth-ex1) here). We understand that the appearance of these strains is transient, and the difference in their appearance in results of the two methods is due to differences in starting conditions of the two methods, and that this difference influences how long transients are present for. Transients close to a state change are likely longer for longer in the temporal method than the replication method.

An interesting feature of these results is that although the position of the oxic to anoxic tipping point is affected by diversity (Figure \@ref(fig:div-repl-meth1) and Figure 3 in the main report) there is no evidence of more tolerant strains being present in the final system state (Figure \@ref(fig:repl-meth-ex1)). This phenomenon is explained in Section \@ref(SB2).

(ref:repl-meth-ex1) Stable states found with the **replication method** with intermediate levels of diversity in all functional groups. Figure features are otherwise the same as those in Figure \@ref(fig:repl-meth2)).

```{r repl-meth-ex1, echo = FALSE,  include=TRUE, fig.cap='(ref:repl-meth-ex1)', fig.height=8, fig.width=8, fig.align="center"}
repl_meth <- readRDS(here("data", "0_ss_finding", "replication_method", "ss_data_9strains_sim_length1e+06_event_definition_2.RDS"))
fig_state_vs_o2diff_sidebyside_dots(repl_meth[94,])
```


## Effect of abundance change event


As mentioned in the main report, to avoid very low strain densities, we added 1 unit of density to every biological state variable every 1,000 hours (a slightly different method produced the same results, see the Supplementary Information for details). We also test the effect of making an abundance floor of 1 unit that was implemented every 1,000 hours. I.e. any abundances that were lower than 1 unit were set to 1 unit, every 1,000 hours. As shown in Figure \@ref(fig:div-temp-eventdef1), the results with this floor abundance are similar as when 1 was added every 1,000 hours. Note that a coarser gradient of trait variation was used, hence the saw-tooth patterns. A further difference is the large decrease in resilience of the anoxic to oxic transition above moderate levels of diversity in the SB and SB-SB treatments. This pattern can also occur with addition of 1 abundance unit (e.g., see Figure \@ref(fig:div-temp-meth3), and is discussed in the section that concerns this below (section [SB diversity effects]).

(ref:div-temp-eventdef1) **Results with an abundance floor.** **Left column of panels**: the effect of response trait diversity (y-axis) on the positions of the tipping points (anoxic to oxic in blue, oxic to anoxic in red), which determine the extent of the region of bistability (green shaded region) in the oxygen diffusivity gradient. The left-most region is anoxic only, the middle is oxic or anoxic depending on historical conditions, and the right-most is oxic only. The thick grey vertical lines at -8 and 0 on the x-axis show the extent of the oxygen diffusivity gradient investigated in the simulations. **Right column of panels**: The effect of diversity on resilience, with positive values on the y-axis indicating that diversity has increased resilience, i.e. delayed the shift to the other state.

```{r div-temp-eventdef1, eval = TRUE, echo = FALSE,  include=TRUE, fig.cap='(ref:div-temp-eventdef1)', fig.height=8, fig.width=8, fig.align="center"}
all_stab <- readRDS(here("data", "0_ss_finding", "temporal_method", "event_def1", "processed_data", "stab_data_temporal_method.RDS"))

wait_time <- 1e6
num_strains <- 9
plot_here <- all_stab %>%
  filter(waittime == wait_time)
p1 <- fig_div_vs_o2diff_1strain_7row(plot_here,
                                     which_strain = num_strains,
                                     figure_title = paste0(sim_length,
                                                           " sim. length,\n",
                                                           num_strains,
                                                           " strains"))
p2 <- fig_resilience_vs_div(plot_here,
                            which_strain = num_strains,
                            figure_title = " ")
p1 + p2

```



## Further thoughts

Here we give some further thoughts regarding the comparison of the temporal and replication method for stable state finding.

A particularly notable difference between the two approaches is in the initial condition. In the temporal approach, the initial condition at a new level of oxygen diffusivity is the stable state at the previous level of oxygen diffusivity, while in the approach of Bush et al (2017) the initial conditions are fixed and arbitrary (though this approach is still useful for illustrating the bistability of the system). This difference in initial conditions increases the region of bistability in the temporal approach because as a tipping point approaches, the functional group that will dominate after the regime shift starts from much lower abundances than in the approach by Bush et al (2017) and thus requires stronger amelioration of the environment to take over. Nevertheless, our main conclusions about the effects of functional trait diversity are the same using either approach.

The temporal approach is particularly useful when investigating the effects of strain richness. In preliminary simulations using the Bush et al (2017) approach, we found the counterintuitive result that higher strain richness led to lower resilience. We then recalled that we chose to divide the initial total abundance of the cyanobacterial (CB) functional group equally among the strains (termed a substitutive design in biodiversity manipulation experiments). This meant that the most tolerant CB strain in a three-strain simulation had higher initial abundance than the same most tolerant CB strain in a nine-strain simulation. The greater abundance of the most CB tolerant strain made it possible for a three-strain system to develop to be oxic, whereas the nine-strain system developed to be anoxic, despite identical range of trait variation. We could have chosen to do otherwise, for example start with the least tolerant strains of cyanobacteria as more abundant when the system started with high cyanobacterial abundance, and the most tolerant strain as more abundant when the system starts with low cyanobacterial abundance. Using the temporal approach removed the need to specify initial abundances (except the very first one), and therefore results were not so determined by the assumptions used to determine the initial conditions.


# Effect of simulation duration

## Diversity effects

Recall that the temporal method for finding stable states involves running the simulation for a certain amount of time, termed the "wait time", at a constant level of oxygen diffusivity. At the end of that wait time the state of the system is recorded, and then the oxygen diffusivity is slightly increased or decreased, and the system then simulated again for the duration of the wait time.

The following figures \@ref(fig:div-temp-meth1)-\@ref(fig:div-temp-meth5) show the effects of diversity with long to shorter wait times.

(ref:div-temp-meth1) Effects of diversity with wait time of 1e6 hours (same figure as in main report). (All else as in (Figure \@ref(fig:div-repl-meth1)).

```{r div-temp-meth1, echo = FALSE,  include=TRUE, fig.cap='(ref:div-temp-meth1)', fig.height=7, fig.width=6, fig.align="center"}
all_stab <- readRDS(here("data", "0_ss_finding", "temporal_method", "processed_data", "stab_data_temporal_method.RDS"))

wait_time <- 1e6
num_strains <- 9
plot_here <- all_stab %>%
  filter(waittime == wait_time)
p1 <- fig_div_vs_o2diff_1strain_7row(plot_here,
                                     which_strain = num_strains,
                                     figure_title = paste0(wait_time,
                                                           " wait time,\n",
                                                           num_strains,
                                                           " strains"))
p2 <- fig_resilience_vs_div(plot_here,
                            which_strain = num_strains,
                            figure_title = " ")
p1 + p2

```

(ref:div-temp-meth2) Effects of diversity with wait time of 1e5 hours. (All else as in (Figure \@ref(fig:div-repl-meth1)).

```{r div-temp-meth2, echo = FALSE,  include=TRUE, fig.cap='(ref:div-temp-meth2)', fig.height=7, fig.width=6, fig.align="center"}

wait_time <- 1e5
num_strains <- 9
plot_here <- all_stab %>%
  filter(waittime == wait_time)
p1 <- fig_div_vs_o2diff_1strain_7row(plot_here,
                                     which_strain = num_strains,
                                     figure_title = paste0(wait_time,
                                                           " wait time,\n",
                                                           num_strains,
                                                           " strains"))
p2 <- fig_resilience_vs_div(plot_here,
                            which_strain = num_strains,
                            figure_title = " ")
p1 + p2
```

(ref:div-temp-meth3) Effects of diversity with wait time of 1e4 hours. (All else as in (Figure \@ref(fig:div-repl-meth1)).

```{r div-temp-meth3, echo = FALSE,  include=TRUE, fig.cap='(ref:div-temp-meth3)', fig.height=7, fig.width=6, fig.align="center"}

wait_time <- 1e4
num_strains <- 9
plot_here <- all_stab %>%
  filter(waittime == wait_time)
p1 <- fig_div_vs_o2diff_1strain_7row(plot_here,
                                     which_strain = num_strains,
                                     figure_title = paste0(wait_time,
                                                           " wait time,\n",
                                                           num_strains,
                                                           " strains"))
p2 <- fig_resilience_vs_div(plot_here,
                            which_strain = num_strains,
                            figure_title = " ")
p1 + p2
```

(ref:div-temp-meth4) Effects of diversity with wait time of 1e3 hours. (All else as in Figure \@ref(fig:div-repl-meth1)).

```{r div-temp-meth4, echo = FALSE,  include=TRUE, fig.cap='(ref:div-temp-meth4)', fig.height=7, fig.width=6, fig.align="center"}
wait_time <- 1e3
num_strains <- 9
plot_here <- all_stab %>%
  filter(waittime == wait_time)
p1 <- fig_div_vs_o2diff_1strain_7row(plot_here,
                                     which_strain = num_strains,
                                     figure_title = paste0(wait_time,
                                                           " wait time,\n",
                                                           num_strains,
                                                           " strains"))
p2 <- fig_resilience_vs_div(plot_here,
                            which_strain = num_strains,
                            figure_title = " ")
p1 + p2
```

(ref:div-temp-meth5) Effects of diversity with wait time of 1e2 hours. (All else as in Figure \@ref(fig:div-repl-meth1)).

```{r div-temp-meth5, echo = FALSE,  include=TRUE, fig.cap='(ref:div-temp-meth5)', fig.height=7, fig.width=6, fig.align="center"}

wait_time <- 1e2
num_strains <- 9
plot_here <- all_stab %>%
  filter(waittime == wait_time)
p1 <- fig_div_vs_o2diff_1strain_7row(plot_here,
                                     which_strain = num_strains,
                                     figure_title = paste0(wait_time,
                                                           " wait time,\n",
                                                           num_strains,
                                                           " strains"))
p2 <- fig_resilience_vs_div(plot_here,
                            which_strain = num_strains,
                            figure_title = " ")
p1 + p2
```



## Example of transient dynamics at 1e6 hours

The results below show the stable states as a function of oxygen diffusivity for a system with intermediate level of diversity in all functional groups, with either 1'000'000 hours at each oxygen diffusivity level (Figure \@ref(fig:ss-temp-meth3)), or 2'000'000 hours (Figure \@ref(fig:ss-temp-meth4)). This shows that except very close to the values of oxygen diffusitivity at which a state transition occurs, 1'000'000 hours duration of the simulations is sufficient to reach stable state, or very close to it. Very close to the transitions, even at 2'000'000 hours, the dynamics are still transient, with high tolerance strains at high density, even though they will eventually be outcompeted by low tolerance (higher growth rate) strains.

(ref:ss-temp-meth3) Stable states found with the temporal method with duration at each oxygen diffusivity value of **1e6 hours**. The right column of panels refers to the stable state when oxygen diffusivity is at first high (favouring the oxic state). The left column refers to when oxygen diffusivity is at first low (favouring the anoxic state). Points (which sometimes are so close as to appear as thick lines) show the stable state at the end of each period of constant oxygen diffusivity. Thin lines are for visualisation only, and join the points. Grey arrows show the oxygen diffusivity at which the system flips, and the direction of the flip. The length of the grey arrows is without meaning.

```{r ss-temp-meth3, echo = FALSE,  include=TRUE, fig.cap='(ref:ss-temp-meth3)', fig.height=8, fig.width=8, fig.align="center"}
single_1e6 <- readRDS(here("data", "0_ss_finding", "temporal_method", "single_1e6_result.RDS"))
temp_meth[1,]$ssfind_result[[1]] <- single_1e6
fig_state_vs_o2diff_sidebyside_dots(temp_meth[1,])
```


(ref:ss-temp-meth4) Stable states found with the temporal method with duration at each oxygen diffusivity value of **2e6 hours**. All other aspects are as in Figure \@ref(fig:ss-temp-meth3).

```{r ss-temp-meth4, echo = FALSE,  include=TRUE, fig.cap='(ref:ss-temp-meth4)', fig.height=8, fig.width=8, fig.align="center"}
single_2e6 <- readRDS(here("data", "0_ss_finding", "temporal_method", "single_2e6_result.RDS"))
temp_meth[1,]$ssfind_result[[1]] <- single_2e6
fig_state_vs_o2diff_sidebyside_dots(temp_meth[1,])
```

# SB diversity effects

## SB diversity effect anoxic to oxic transition

Wait times of 1e5 (Figure \@ref(fig:div-temp-meth2) and 1e4 (Figure \@ref(fig:div-temp-meth4) produce qualitatively and often quantitatively very similar to those for wait times of 1e6 (Figure \@ref(fig:div-temp-meth1)). There is, however, a notable difference when there is variation in only SB, or CB-SB variation treatments with wait time of 1e4 (Figure \@ref(fig:div-temp-meth4)). Here, moderate increases in diversity have the same effect as with wait times of 1e6.

However, larger increases in diversity suddenly cause a large reduction in resilience of the anoxic-oxic transition. Figure \@ref(fig:ss-temp-meth1) gives an example of the stable states when diversity is moderate -- increases in oxygen diffusivity cause strain replacement in the SB to the more tolerant strains, which then delay the shift.  Suprisingly, when there is just a little more diversity in the SB then the anoxic to oxic transition happens earlier, i.e. there is large decrease in resilience \@ref(fig:ss-temp-meth2).

(ref:ss-temp-meth1) Stable state of the system with **moderate** level of diversity in only SB, and no diversity in the other two groups. All other aspects are as in Figure \@ref(fig:ss-temp-meth3).

```{r ss-temp-meth1, echo = FALSE,  include=TRUE, fig.cap='(ref:ss-temp-meth1)', fig.height=8, fig.width=8, fig.align="center"}
wait_time <- "1e+04"
ss_9s <- readRDS(here::here("data", "0_ss_finding", "temporal_method", paste0("ss_data_9strains_waittime", wait_time, "_event_definition_2.RDS")))
#stab_9s <- readRDS(here::here(\"data", "0_ss_finding", "temporal_method", paste0("stab_data_9strains_waittime", wait_time, "_event_definition_2.RDS"))


#max <- max(ss_3s$PB_var_gmax_s)
#f <- 0.625
#fv <- f*max

only_SB_variable <- ss_9s %>%
  filter(
    abs(CB_var_gmax_s) < 0.0001,
    abs(PB_var_gmax_s) < 0.0001
  )
only_SB_variable <- only_SB_variable[order(only_SB_variable$SB_var_gmax_s), ]

#only_SB_variable$SB_var_gmax_s

fig_state_vs_o2diff_sidebyside_dots(only_SB_variable[13,])


#fig_state_vs_o2diff(only_SB_variable[13,])
```



(ref:ss-temp-meth2)  Stable state of the system with **higher than moderate** level of diversity in only SB, and no diversity in the other two groups. All other aspects are as in Figure \@ref(fig:ss-temp-meth1).

```{r ss-temp-meth2, echo = FALSE,  include=TRUE, fig.cap='(ref:ss-temp-meth2)', fig.height=8, fig.width=8, fig.align="center"}
fig_state_vs_o2diff_sidebyside_dots(only_SB_variable[14,])
```

We believe that this phenomenon is caused by an effect that we explain with reference to an anology of using stepping stones to cross a river. Increasing diversity in our simulations is akin to increasing the width of the river, but while keeping the number of stepping stones (strains) constant. So long as the river is not too wide, we can still cross it, but once the width of the river is such that the stepping stones are too far apart, we can't cross the river. And this happens suddenly, the width increases just a tiny bit more, and we suddenly can't cross the river when we could before.

In the simulated microbial ecosystem, the strains are the stepping stones, and it is much hard (takes longer) for strains to replace each other when there is greater distance (in trait space) between them. When they can no longer replace each other in the time available, the system behaves as if only the least tolerant, highest growth rate strain (lighted shade of colour) is present. In the case illustrated above, this leads to much lower resilience of the anoxic system state.

This phenomena is dependent on having static trait values for the strains. If strain traits were dynamic (e.g. due to evolution), then we expect this result to not occur, and rather for the effects of diversity with two or three strains to be the same as those with six or nine.

## SB diversity effect oxic to anoxic transition {#SB2}


When the environment ameliorates for the sulphur bacteria, there can be limited evidence of strain replacement (in final state) along the oxygen diffusivity gradient -- either the system is oxic or the least tolerant strain SB9 dominates. And yet the switch to anoxic occurs earlier than when there is no diversity, which suggests there is some role of the more tolerant strains. Indeed Uriah showed that the presence of only the most tolerant strain is sufficient to give an earlier switch, even though it is not present in the final state when less tolerant strains are present. And he showed that the presence of only the least tolerant strain creates a later switch than when there are more tolerant strains.

The explanation is that the most tolerant strain does play a role, but only a transient one. The following dynamics are for the system starting oxic, and with a value of oxygen diffusivity (log10(a_O) = -4.8) for which the system remains oxic if there is no diversity (Figure \@ref(fig:sb-div-effect3)), but switches to anoxic if there is diversity (Figure \@ref(fig:sb-div-effect4)). There is only diversity in the sulphur bacteria. The most tolerant strain does at first grow, but is then outcompeted by less tolerant strains as the environment ameliorates (temporally).

```{r echo = FALSE}
run_sims_this_section <- TRUE
```

```{r eval = run_sims_this_section, echo = FALSE}
#var_expt <- readRDS(here::here("data", "9_strains", "ss_data_1e6_x2x6_factorial.RDS"))
var_expt_levels <- var_expt[,1:6]
no_diversity <- which(rowSums(abs(var_expt_levels))==0)
max_diversty_all <- which(max(rowSums(abs(var_expt_levels))) ==
                            rowSums(abs(var_expt_levels)))
max_only_CB_diversity <- which(max(rowSums(abs(var_expt_levels[,1:2]))) ==
                            rowSums(abs(var_expt_levels[,1:2])) &
                              rowSums(abs(var_expt_levels[,3:6]))==0)
max_only_SBPB_diversity <- which(max(rowSums(abs(var_expt_levels[,3:6]))) ==
                            rowSums(abs(var_expt_levels[,3:6])) &
                              rowSums(abs(var_expt_levels[,1:2]))==0)
```

```{r  eval = run_sims_this_section, echo = FALSE}

num_CB_strains <- 9
num_SB_strains <- 9
num_PB_strains <- 9

sp <- new_strain_parameter(
  n_CB = num_CB_strains,
  n_PB = num_SB_strains,
  n_SB = num_PB_strains,
  values_initial_state = "bush_ssfig3"
)

parameter <- new_runsim_parameter(
  dynamic_model = bushplus_dynamic_model,
  event_definition = event_definition_1,
  event_interval = 100,
  noise_sigma = 0,
  minimum_abundances = rep(1, 3),
  sim_duration = 2000,
  sim_sample_interval = 100,
  strain_parameter = sp,
  log10a_series = c(
    log10(sp$a_O),
    log10(sp$a_O)
  )
)
names(parameter$minimum_abundances) <- c("CB", "PB", "SB")

rm(sp)

parameter$strain_parameter <- var_expt[no_diversity,]$pars[[1]]
parameter$sim_duration <- 100000
parameter$result <- NULL
parameter$log10a_series <- c(-4.8, -4.8)
parameter$strain_parameter$initial_state <- new_initial_state(
  nrow(parameter$strain_parameter$CB),
  nrow(parameter$strain_parameter$PB),
  nrow(parameter$strain_parameter$PB),
  values = "bush_ssfig3"
)
parameter$strain_parameter$initial_state[grep("CB_", names(parameter$strain_parameter$initial_state))] <- 10^10/nrow(parameter$strain_parameter$CB)

sim_res_novar1 <- run_simulation(parameter)
dir.create(here::here("data", "2_supplement"), recursive = TRUE, showWarnings = FALSE)
saveRDS(sim_res_novar1, here::here("data", "2_supplement", "puzzle1_1.RDS"))
```

(ref:sb-div-effect3)  Dynamics of the system with no diversity in any functional group, and log10(oxygen diffusivity) = -4.8. The system remains oxic when starting in the oxic state.

```{r  sb-div-effect3, echo = FALSE,  include=TRUE, fig.cap='(ref:sb-div-effect3)', fig.height=8, fig.width=8, fig.align="center"}
sim_res_novar1 <- readRDS(here::here("data", "2_supplement", "puzzle1_1.RDS"))
plot_dynamics(sim_res_novar1)
#ggsave(here("simulations", "expt2", "figures", "switching_novar.pdf"), width = 10)
```


```{r  eval = run_sims_this_section, echo = FALSE}
parameter$strain_parameter <- var_expt[max_only_SBPB_diversity,]$pars[[1]]
#parameter$sim_duration <- 100000
#parameter$result <- NULL
#parameter$log10a_series <- c(-5.2, -5.2)
#parameter$strain_parameter$initial_state <- new_initial_state(
#  nrow(parameter$strain_parameter$CB),
#  nrow(parameter$strain_parameter$PB),
#  nrow(parameter$strain_parameter$PB),
#  values = "bush_ssfig3"
#)
parameter$strain_parameter$initial_state[grep("CB_", names(parameter$strain_parameter$initial_state))] <- 10^10/nrow(parameter$strain_parameter$CB)
sim_res_highvar1 <- run_simulation(parameter)
saveRDS(sim_res_highvar1,here::here("data", "2_supplement", "puzzle1_2.RDS"))
```


(ref:sb-div-effect4) Dynamics of the system with diversity in sulfur bacteria and otherwise exactly the same conditions as in Figure \@ref(fig:sb-div_effect3). The system flips from oxic to anoxic, whereas it did not when there was no diversity.

```{r sb-div-effect4, echo = FALSE,  include=TRUE, fig.cap='(ref:sb-div-effect4)', fig.height=8, fig.width=8, fig.align="center"}
sim_res_highvar1 <- readRDS(here("data", "2_supplement", "puzzle1_2.RDS"))
plot_dynamics(sim_res_highvar1)
#ggsave(here("simulations", "expt2", "figures", "switching_novar.pdf"), width = 10)
```


# PB diversity effects


```{r echo = FALSE}
ss_9s <- readRDS(here::here("data", "0_ss_finding", "temporal_method", "ss_data_9strains_waittime1e+06_event_definition_2.RDS"))
only_PB_variable <- ss_9s %>%
  filter(
    abs(CB_var_gmax_s) < 0.0001,
    abs(SB_var_gmax_s) < 0.0001
  )
only_PB_variable <- only_PB_variable[order(only_PB_variable$PB_var_gmax_s), ]

only_PB_stab <- readRDS(here::here("data", "0_ss_finding", "temporal_method", "processed_data", "stab_data_temporal_method.RDS")) %>%
  filter(
    num_strains == 9,
    waittime == 1e6,
    var_treat == "PB",
    Species == "SB_tot"
  )
only_PB_stab <- only_PB_stab[order(only_PB_stab$PB_var_gmax_s), ]

sim1 <- 2
sim2 <- 10

aO_flip_sim1 <- only_PB_stab[sim1,"hyst_max_log"]
aO_flip_sim2 <- only_PB_stab[sim2,"hyst_max_log"]


```

Increases in the diversity within the PB functional group leads to lower resilience of the anoxic state (Figure \@ref(fig:div-temp-meth1), Panel PB, blue line). For example, a small amount of variation in only the PB functional group, and no variation in other functional groups, results in transition from anoxic to oxic at approximately $log_{10}$(oxygen diffusivity) = `r round(aO_flip_sim1, 2)` (Figure \@ref(fig:pbdiv-only-1)). Whereas, a moderate amount of variation in only the PB functional group, and no variation in other functional groups, results in transition from anoxic to oxic at approximately $log_{10}$(oxygen diffusivity) = `r round(aO_flip_sim2, 2)` (Figure \@ref(fig:pbdiv-only-2)).


(ref:pbdiv-only-1) Right-hand panels show the transition from anoxic to oxic state when oxygen diffusivity increases. The results here are for a **low amount of variation in only the PB functional group**. The transition from anoxic to oxic occurs at approximately $log_{10}$(oxygen diffusivity) = `r round(aO_flip_sim1, 2)`. All other aspects are the same as in Figure \@ref(fig:repl-meth2).

```{r pbdiv-only-1, echo = FALSE,  include=TRUE, fig.cap='(ref:pbdiv-only-1)', fig.height=8, fig.width=8, fig.align="center"}
fig_state_vs_o2diff_sidebyside_dots(only_PB_variable[sim1,])
```

(ref:pbdiv-only-2) Right-hand panels show the transition from anoxic to oxic state when oxygen diffusivity increases. The results here are for a **moderate amount of variation in only the PB functional group**. The transition from anoxic to oxic occurs at approximately $log_{10}$(oxygen diffusivity) = `r round(aO_flip_sim2, 2)`. All other aspects are the same as in Figure \@ref(fig:repl-meth2).

```{r pbdiv-only-2, echo = FALSE,  include=TRUE, fig.cap='(ref:pbdiv-only-2)', fig.height=8, fig.width=8, fig.align="center"}
fig_state_vs_o2diff_sidebyside_dots(only_PB_variable[sim2,])
```


This result is different to the effect of diversity within the CB and SB functional groups, which both cause increases in resilience (Figure \@ref(fig:div-temp-meth1)). Why does diversity in the PB functional group reduce the resilience of the state it dominates?

The phototrophic sulfur bacteria (PB) in the model ecosystem produce oxidised sulfur compounds (SO), and consume reduced sulfur compounds (SR). Since SR inhibits the cyanobacteria, PB can have a positive effect on CB via their consumption of SR. Hence, high growth rates of PB will have a positive effect on on CB, and therefore favour the oxic state. We would expect to see that higher diversity of PB is associated with lower SR and higher SO before the transition.

Another pathway by which higher PB growth rate can favour the oxic state is by PB inhibiting PB and SB (and thus favouring CB). This effect occurs because PB consumes SR, making less SR available for abiotic oxidation (SR + O -> SO). Reduced abiotic oxidation leaves greater amounts of O in the environment, and O inhibits. We would expect to see that higher diversity of PB is associated with higher O before the transition.

There is, however, at least one pathway by which PB can favour the anoxic state. PB produces SO which is consumed by SB, and SB produce SR, which inhibits CB.

Looking at the strain replacement that occurs across the oxygen diffusivity gradient, we see that as oxygen diffusivity increases, then the more oxygen tolerant strains of PB replace the less tolerant ones. This is because these more tolerant strains have higher realised growth rates under the prevailing environmental conditions (even though they have lower maximum growth rate than lower tolerance strains). Having an even more tolerant strain available (which is what happens when there is greater PB diversity) gives the opportunity for even higher realised growth rates, which via the effect pathways mentioned above, can favour the oxic state.

The expected effects of having a more PB tolerant strain (because there is higher PB diversity) is shown in Figure \@ref(fig:pbdiv-only-3)). As the transition is approached, higher PB diversity leads to higher oxygen concentration, higher SO concentration, and lower SR concentration, than in a simulation with lower PB diversity. All these differences in substrate concentrations are in the direction of favouring the oxic state, and thus the system transitions earlier to the oxic state.

(ref:pbdiv-only-3) Concentrations of three substrates (one in each panel) in a low PB diversity simulation (x-axis) versus concentration in a high PB diversity simuation (y-axis). Only a small range of oxygen diffusivity is show, and result only shown for increasing oxygen diffusivity. The black line is the 1:1 line.


```{r pbdiv-only-3, echo = FALSE,  include=TRUE, fig.cap='(ref:pbdiv-only-3)', fig.height=5, fig.width=8, fig.align="center"}


stab_9s <- readRDS(here("data", "0_ss_finding", "temporal_method", "ss_data_9strains_waittime1e+06_event_definition_2.RDS"))



ss1 <- only_PB_variable[sim1,]
ss2 <- only_PB_variable[sim2,]

dd1 <- ss1$ssfind_result[[1]] %>%
  pivot_longer(names_to = "State_variable", values_to = "Quantity_sim1", 2:32)
dd2 <- ss2$ssfind_result[[1]] %>%
  pivot_longer(names_to = "State_variable", values_to = "Quantity_sim2", 2:32)
dd <- full_join(dd1, dd2)
rm(ss1, ss2, dd1, dd2)

labs <- seq(-3.5, -3.3, by=0.05)

dd %>%
  filter(State_variable %in% c("O", "SR", "SO"),
         direction == "up",
         a_O < as.numeric(aO_flip_sim2),
         a_O > -3.5) %>%
  ggplot(aes(x = log10(Quantity_sim1),
                 y = log10(Quantity_sim2),
                 col = a_O )) +
  geom_point(lwd = 3) +
  geom_path() +
  scale_color_gradient(low = "yellow", high = "red", na.value = NA,
                       breaks = labs,
                       labels = labs) +
  #coord_trans(x = "log10", y = "log10") +
  facet_wrap( ~ State_variable, scales = "free") +
  geom_abline(intercept = 0, slope = 1) +
  xlab("Log10(Concentration)\nLow PB diversity") +
  ylab("Log10(Concentration)\nHigh PB diversity") +
  labs(col="Log10(Oxygen diffusivity)") +
  theme_bw() +
  theme(legend.position="top")



```

There still remains the question of why the effect of PB diversity saturates. We don't currently have a good explanation for this, just as we don't have good explanations for other effects of diversity that are non-linear.


# Effect of number of strains

(ref:div-stab-multstrain1)  Effects of number of strains and of diversity among strains.

```{r div-stab-multstrain1, echo = FALSE,  include=TRUE, fig.cap='(ref:div-stab-multstrain1)', fig.height=8, fig.width=8, fig.align="center"}
all_stab <- readRDS(here("data", "0_ss_finding", "temporal_method", "processed_data", "stab_data_temporal_method.RDS"))
which_strains <- c(2, 3, 6, 9)
which_wait_time<- 1e6
figure_title <- " "

fig_div_vs_o2diff_multistrain(all_stab, which_strains,
                              which_wait_time, figure_title)
```




# Finding the separatrix

In the original publication ([Bush et al 2017](<https://www.nature.com/articles/s41467-017-00912-x>)) Figure 3a shows a separatrix in the cyanobacteria abundance - oxygen diffusivity dimensions of the system. If the system has initial cyanobacterial abundance greater than the value at the separatrix then the cyanobacterial abundance increases, and the system goes to the oxic stable state. Conversely, if the system has initial cyanobacterial abundance greater than the value at the separatrix then the cyanobacterial abundance decreases, and the system goes to the anoxic stable state.

It is critical to note, however, that the position of the separatrix depends on both the parameters of the system, and the initial conditions of variables other than cyanobacterial abundance. If the system were started with higher initial concentration, then the position of the separatrix would change (as would the values of oxygen diffusivity at which the system tipped from anoxic to oxic, and from oxic to anoxic).

This issue of dependence of the position of the separatrix on the value of initial condition of multiple state variables has particular significance when there are multiple strains per functional group. Then one cannot just vary initial total cyanobacterial abundance (as was done to create the separatrix on Figure 3a in the original publication) but one must also define how the initial abundance of each of the strains varies. One might choose to make each strain have equal initial abundance, and to vary the total (as we did in our implementation of the replication method in the main article).

We could, however, and arguably should, give the most tolerant strain of cyanobacteria higher initial relative abundance when total initial cyanobacterial abundance was low, and the least tolerant strain higher initial relative abundance when total cyanobacterial abundance was high. And we would need to specify the total and relative abundance of all cyanobacteria (and sulfur bactria) strains. Thus, with a system as complex as the 9 strain system, which has 31 state variables the separatrix is very high dimensional, and evaluating (and plotting) it in one dimension requires many assumption. We chose to not attempt to find a meaningful set of assumptions in this study, though not because we think it would be unprofitable to do so, but rather because we did not want to risk distracting attention from findings we consider to be significant enough in the own right.
