---
title: Supplementary Content
subtitle: Functional diversity ... Predictions of a model of an oxic-anoxic microbial ecosystem 
author: "Owen L Petchey, Rainer Krug, Marcel Suleiman, ???others???"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = TRUE)
```

```{r echo = FALSE}
rm(list = ls())
library(tidyverse)
library(microxanox)
library(patchwork)
library(here)
source(here("r/various_useful_functions.r"))
colfunc_CB <- colorRampPalette(c("#024F17", "#B5FFC9"))
colfunc_SB <- colorRampPalette(c("#7D1402", "#FCBEB3"))
colfunc_PB <- colorRampPalette(c("#6E0172", "#F9AEFC"))
zero <- 0
unity <- 1
```

# Introduction

This document contains the Supporting Content for the report *?????????????*.

# Creating among strain diversity

Here we provide additional description of the method used to create strain variation within functional groups. The following should be read only after the relevant sections of the main text.

Take for example the cyanobacteria functional group, a reference maximum growth rate parameter $G_{max,CB}$ and a reference tolerance parameter $h_{SR,CB}$. Recall that amount of among strain variation is controlled by the two meta-parameters $Div_{G_{max,CB}}$ and $Div_{h_{SR,CB}}$. To create a tradeoff, the two meta-parameters were always of different sign. The among strain variation was calculated such that the growth rate of strain $i = 1$ was a factor $1/({2Div_{G_{max,CB}}})$ of the reference growth rate, and the growth rate of the $i = n$ strain was a factor $2Div_{G_{max,CB}}$ of the reference growth rate. The growth rate of the $i = {2,...n-1}$ other strains was the reference growth rate multiplied by a factor that was equally distributed between the factor of the $i = 1$ and $i = n$ strain. This implementation of the variation and trade-off has the assumption of a linear trade-off of log-log transformed among-strain variation. Hence, for example, with the reference growth rate $G_{max,CB} = 0.05$, among strain variation of $Div_{G_{max,CB}} = 1$, and nine strains ($n = 9$), the growth rates of the nine strains are 0.025, 0.03, 0.035, 0.042, 0.05, 0.059, 0.071, 0.084, 0.1. Put another way, the growth rate parameter of the $i$-th of the $n$ strains in a functional group was calculated as $G_{max,i} = D_i * G_{max}$ where $D_i$ is the $i$-th element of the set $D = {2f(x)Div_{G_{max}} |x ∈ N, x ≤ n}$, where $f(x) = (x − (n + 1)/2)/((n − 1)/2)$.

This procedure ensures that the range of trait values is independent of the number of strains. When there were only two strains, the two strains took the minimum and maximum traits values, as defined by the $Div$ variable for that trait. When there were three strains, one had the minimum trait value, one the maximum, and one the mean. With nine strains, one had the minimum trait value, one the maximum, one the mean, and three were equally spaced (on log scale) between the minimum and the mean, and the remaining three between the maximum and the mean. 

# Visualising among strain diversity

Here we show three visualisations, one for nine strains, one for three, and one for two.

In each, the top row of three graphs shows the diversity and tradeoff in each of the three functional groups. The most tolerant strain is always in the darker shade.The lower row of three graphs shows the relationship between realised growth rate as a function of the respective inhibiting substance, e.g. sulfide for the cyanobacteria. In these lower graphs only the least and most tolerant strains are shown. The lines cross due to the tradeoff shown in the upper graph. At high concentrations of the inhibiting substance the more tolerant strain has higher realised growth rate, while at lower concentrations it is the less tolerant strain that has the higher realised growth rate.

```{r  echo = FALSE}
CB_var_multiplier <- 2
SBPB_var_multiplier <- 6
CB_gmax_div <- 0.015789474 * CB_var_multiplier
CB_h_div <- -0.08 * CB_var_multiplier
SB_gmax_div <- 0.015789474 * SBPB_var_multiplier
SB_h_div <- -0.323  * SBPB_var_multiplier
PB_gmax_div <- 0.015789474  * SBPB_var_multiplier
PB_h_div <- -0.323  * SBPB_var_multiplier
num_div_treatment_levels <- 2
```

## Nine strains

```{r nine-strains, echo = FALSE}

num_CB_strains <- 9
num_PB_strains <- 9
num_SB_strains <- 9
var_expt <- create_diversity_factorial(
  zero = zero, unity = unity,
  num_div_treatment_levels = num_div_treatment_levels,
  CB_gmax_div = CB_gmax_div, CB_h_div = CB_h_div,
  SB_gmax_div = SB_gmax_div, SB_h_div = SB_h_div,
  PB_gmax_div = PB_gmax_div, PB_h_div = PB_h_div,
  default_9strain = new_strain_parameter(
    n_CB = num_CB_strains,
    n_SB = num_SB_strains,
    n_PB = num_PB_strains,
    values_initial_state =  "bush_ssfig3"
  )
)
display_diversity(4,
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains
)
```

## Three strains

```{r three-strains, echo = FALSE}

num_CB_strains <- 3
num_PB_strains <- 3
num_SB_strains <- 3
var_expt <- create_diversity_factorial(
  zero = zero, unity = unity,
  num_div_treatment_levels = num_div_treatment_levels,
  CB_gmax_div = CB_gmax_div, CB_h_div = CB_h_div,
  SB_gmax_div = SB_gmax_div, SB_h_div = SB_h_div,
  PB_gmax_div = PB_gmax_div, PB_h_div = PB_h_div,
  default_9strain = new_strain_parameter(
    n_CB = num_CB_strains,
    n_SB = num_SB_strains,
    n_PB = num_PB_strains,
    values_initial_state =  "bush_ssfig3"
  )
)
display_diversity(4,
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains
)
```

## Two strains

```{r two-strains, echo = FALSE}

num_CB_strains <- 2
num_PB_strains <- 2
num_SB_strains <- 2
var_expt <- create_diversity_factorial(
  zero = zero, unity = unity,
  num_div_treatment_levels = num_div_treatment_levels,
  CB_gmax_div = CB_gmax_div, CB_h_div = CB_h_div,
  SB_gmax_div = SB_gmax_div, SB_h_div = SB_h_div,
  PB_gmax_div = PB_gmax_div, PB_h_div = PB_h_div,
  default_9strain = new_strain_parameter(
    n_CB = num_CB_strains,
    n_SB = num_SB_strains,
    n_PB = num_PB_strains,
    values_initial_state =  "bush_ssfig3"
  )
)
display_diversity(4,
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains
)
```



# Robustness of stable state finding

## Method for finding stable states

We now discuss two approaches for finding how the stable state of the system varies along the gradient of oxygen diffusivity when there exists the possibility of multiple stable states. In the main article we describe and report results of the method that we term the *Temporal method*.

Here we also describe and give results of what we term the *Replication method*. In this, we made a separate simulations for each of many values of oxygen diffusivity, ran the simulations for long enough to ensure transients had passed, and recorded the state. We ran multiple simulations per value of oxygen diffusivity, and started them with different initial conditions (either low or high total cyanobacterial abundance), so as to check for presence of alternate stable states. This method used by [Bush et al 2017](https://www.nature.com/articles/s41467-017-00912-x). We term it the replication method since it is achieved by having many independent replicates of the ecosystem, each with a different oxygen diffusivity, and also a separate replicate for each of the different chosen initial conditions.

As is shown in the figures below, the temporal method results in a larger region of bistability than the replication method, but only during increasing oxygen diffusivities. The difference in results occurs because, as mentioned above, the initial conditions differ between the two approaches. For example, in the temporal method, the oxygen concentration in the anoxic state is lower than the initial oxygen concentration in the replication approach, and **Owen guesses that** the sulfide concentration is higher **check that last statement**.

### Replication method, no diversity

In the following graph, the solid (down) line refers to the stable state when cyanobacteria begin at high abundance (favouring the oxic state). The dashed up line refers to when their initial abundnace is low (favouring the anoxic state).Stable states found with the replication method. Please note: i) that near vertical lines indicate the position of a tipping point and hence the system cannot exist on point of that part of the line; ii) the separatrix (the unstable equilibrium) is not shown.

```{r repl_meth1, echo=FALSE}
repl_meth <- readRDS(here("experiments/0_ss_finding/replication_method/9_strains/data/ss_data_1e6_x2x6_factorial.RDS"))
temp_meth <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_SS_data.RDS"))
## To be completed.
plot_ss_result1(repl_meth,
                result_index = 1,
                filename_prefix = NULL,
                save_image_file = FALSE)
```

### Temporal method, no diversity

Same as for the previous graph.

```{r temp_meth1, echo=FALSE}
plot_ss_result3(temp_meth, 1)
```


### Both methods overlaid, no diversity

Stable states of the two methods overlaid, the temporal method with a dashed line, and the replication method with a solid line.

```{r both_meth1, echo=FALSE}
repl_method_1 <- repl_meth$ss_res[[1]] %>%
     mutate(time = NA,
            direction = ifelse(initial_N_CB == 1, "up", "down")) %>%
  select(names(temp_meth$ssfind_result[[1]]))
   
ss_result1 <- repl_method_1
ss_result2 <- temp_meth$ssfind_result[[1]]

plot_ss_result6(repl_method_1,
                temp_meth$ssfind_result[[1]],
                xlims = c(-8, 0))
```

### Effect of diversity, replication method

The replication method shows the same effects of functional diversity as those revealed by the temporal method:

-   Introducing functional diversity in all three functional groups increases the region of bistability relative to when there is no diversity within all functional groups).
-   Introducing functional diversity in only the cyanobacteria function group delays (with respect to the oxygen diffusivity it occurs at) the switch to the anoxic state as oxygen diffusivity is reduced, but has no effect on the oxygen diffusivity at which the anoxic to oxic transition occurs .
-   Introducing function diversity in only the sulfur bacteria delays (with respect to the oxygen diffusivity it occurs at) the switch from anoxic to oxic, and advances the switch from oxic to anoxic.

These results are shown in the figure below, which shows results of the replication method.


```{r echo = FALSE, eval = TRUE}
stab_data <- readRDS(here("experiments/0_ss_finding/replication_method/9_strains/data/small_stab_data_1e6_x2x6_factorial.RDS"))

all_stab <- stab_data

#all_stab <- stab_9s

CB_vars <- unique(all_stab$CB_var_gmax_s)
SB_vars <- unique(all_stab$SB_var_gmax_s)

CB_all_stab <- all_stab %>%
  filter(SB_var_gmax_s == 0) %>%
  mutate(var_treat = "CB",
         var_gmax = CB_var_gmax_s)

SBPB_all_stab <- all_stab %>%
  filter(CB_var_gmax_s == 0) %>%
  mutate(var_treat = "SB-PB",
         var_gmax = SB_var_gmax_s)

for_join <- tibble(CB_var_gmax_s = sort(CB_vars),
                   SB_var_gmax_s = sort(SB_vars))
CBSBPB_all_stab <- all_stab %>%
  right_join(for_join) %>%
  mutate(var_treat = "CB-SB-PB",
         var_gmax = CB_var_gmax_s)

all_stab_results <- CB_all_stab %>%
  bind_rows(SBPB_all_stab) %>%
  #  bind_rows(results3) %>%
  # bind_rows(results4) %>%
  bind_rows(CBSBPB_all_stab)

all_stab_results <- all_stab_results %>%
  mutate(var_treat = forcats::fct_relevel(var_treat, levels = c("CB", "SB-PB", "CB-SB-PB")))

```


```{r echo = FALSE, eval = TRUE}
all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "SR") %>%
  ggplot(aes(x = var_gmax)) +
  #ggplot(aes(x = var_gmax,
  #           col = as.factor(num_strains))) +
  geom_line(aes(y = hyst_min_log), lwd = 2, alpha = 0.8) +
  geom_line(aes(y = hyst_max_log), lwd = 2, alpha = 0.8) +
  facet_wrap( ~ var_treat, scales = "free_y", nrow = 3) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[log10 uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") +
  coord_flip() +
  #guides(col = guide_legend(title="Number of strains")) +
  theme(
    legend.position="top"
    #strip.background = element_blank(),
    #strip.text.x = element_blank()
  ) +
  geom_hline(yintercept = c(-8, 0), col = "grey", lwd = 3)

#ggsave(here("experiments/1_figures_main_ms/figure_5.pdf"),
#       width = 5, height = 4)

```

The figure above shows the effect of response trait diversity (y-axis) on the positions of the tipping points (show by dark lines), which determine the extent of the region of bistability in the oxygen diffusivity gradient. The left-most region is anoxic only, the middle is oxic or anoxic depending on historical conditions, and the right-most is oxic only. The thick grey vertical lines at -8 and 0 on the x-axis show the extent of the oxygen diffusivity gradient investigated in the simulations.

### Further information

Here we give some further thoughts regarding the comparison of the temporal and replication method for stable state finding.

A particularly notable difference between the two approaches is in the initial condition. In the temporal approach, the initial condition at a new level of oxygen diffusivity is the stable state at the previous level of oxygen diffusivity, while in the approach of Bush et al (2017) the initial conditions are fixed and arbitrary (though this approach is still useful for illustrating the bistability of the system). This difference in initial conditions increases the region of bistability in the temporal approach because as a tipping point approaches, the functional group that will dominate after the regime shift starts from much lower abundances than in the approach by Bush et al (2017) and thus requires stronger amelioration of the environment to take over. Nevertheless, our main conclusions about the effects of functional trait diversity are the same using either approach. 

The temporal approach is particularly useful when investigating the effects of strain richness. In preliminary simulations using the Bush et al (2017) approach, we found the counterintuitive result that higher strain richness led to lower resilience. We then recalled that we chose to divide the initial total abundance of the cyanobacterial (CB) functional group equally among the strains (termed a substitutive design in biodiversity manipulation experiments). This meant that the most tolerant CB strain in a three-strain simulation had higher initial abundance than the same most tolerant CB strain in a nine-strain simulation. The greater abundance of the most CB tolerant strain made it possible for a three-strain system to develop to be oxic, whereas the nine-strain system developed to be anoxic, despite identical range of trait variation. We could have chosen to do otherwise, for example start with the least tolerant strains of cyanobacteria as more abundant when the system started with high cyanobacterial abundance, and the most tolerant strain as more abundant when the system starts with low cyanobacterial abundance. Using the temporal approach removed the need to specify initial abundances (except the very first one), and therefore results were not so determined by the assumptions used to determine the initial conditions. 


## Effect of immigration / minimum abundance event

The simulations include two methods to prevent very low densities. One is to make a floor density; if densities go below this, then they are set to that floor value. Another is to regularly add a density of 1 to all biological state variables. Here are the results for adding 1.

```{r}
## Figure 5 ----
## Region of bistability by diversity and number of strains.

# ss_2s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/2_strain_SS_data_1e6.RDS"))
# stab_2s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/2_strain_stab_data_1e6.RDS")) %>%
#   mutate(num_strains = 2)
# ss_2s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/2_strain_SS_data_1e6_sub1.RDS"))
# stab_2s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/2_strain_stab_data_1e6_sub1.RDS")) %>%
#   mutate(num_strains = 2)
# 
# 
# ss_3s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/3_strain_SS_data_1e6.RDS"))
# stab_3s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/3_strain_stab_data_1e6.RDS")) %>%
#   mutate(num_strains = 3) 
# ss_3s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/3_strain_SS_data_1e6_sub1.RDS"))
# stab_3s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/3_strain_stab_data_1e6_sub1.RDS")) %>%
#   mutate(num_strains = 3)
# 
# 
# 
# 
# ss_6s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/6_strain_SS_data_1e6.RDS"))
# stab_6s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/6_strain_stab_data_1e6.RDS")) %>%
#   mutate(num_strains = 6) 
# ss_6s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/6_strain_SS_data_1e6_sub1.RDS"))
# stab_6s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/6_strain_stab_data_1e6_sub1.RDS")) %>%
#   mutate(num_strains = 6)
# 

# expt_res <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_SS_data_1e6_eventdef2.RDS"))
# num_cores <- 8
# expt_res <- expt_res %>%
#   mutate(ssfind_result = list(get_total_bio(ssfind_result)))
# cluster1 <- multidplyr::new_cluster(num_cores)
# multidplyr::cluster_library(cluster1, c("microxanox", "dplyr"))
# system.time({
#   stab_data <-  expt_res %>%
#     multidplyr::partition(cluster1) %>%
#     mutate(stability_measures = list(get_stability_measures_new(ssfind_result))) %>%
#     collect() %>%
#     unnest(cols = c(stability_measures)) 
# })
# saveRDS(stab_data, here("experiments/0_ss_finding/temporal_method/data/9_strain_stab_data_1e6_eventdef2.RDS"))

stab_9s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_stab_data_1e6_eventdef2.RDS")) %>%
  mutate(num_strains = 9) 

stab_9s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_stab_data_1e6_eventdef2.RDS")) %>%
  mutate(num_strains = 9) 


#ss_9s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_SS_data_1e6_sub1.RDS"))
#stab_9s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_stab_data_1e6_sub1.RDS")) %>%
#  mutate(num_strains = 9)

#stab_9s_diff3 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_stab_data_1e6_diff3.RDS")) %>%
#  mutate(num_strains = 9) 


# all_stab <- stab_2s %>%
#   bind_rows(stab_2s_sub1) %>%
#   bind_rows(stab_3s) %>%
#   bind_rows(stab_3s_sub1) %>%
#   bind_rows(stab_6s) %>%
#   bind_rows(stab_6s_sub1) %>%
#   bind_rows(stab_9s) %>%
#   bind_rows(stab_9s_sub1) %>%
#   bind_rows(stab_9s_diff3)

all_stab <- stab_9s

CB_vars <- unique(all_stab$CB_var_gmax_s)
SB_vars <- unique(all_stab$SB_var_gmax_s)
PB_vars <- unique(all_stab$PB_var_gmax_s)

CB_all_stab <- all_stab %>%
  filter(SB_var_gmax_s == 0,
         PB_var_gmax_s == 0) %>%
  ungroup() %>%
  mutate(var_treat = "CB",
         var_gmax = CB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax))
SB_all_stab <- all_stab %>%
  filter(CB_var_gmax_s == 0,
         PB_var_gmax_s == 0)  %>%
  ungroup() %>%
  mutate(var_treat = "SB",
         var_gmax = SB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax))
PB_all_stab <- all_stab %>%
  filter(CB_var_gmax_s == 0,
         SB_var_gmax_s == 0) %>%
  ungroup()  %>%
  mutate(var_treat = "PB",
         var_gmax = PB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax))

for_join <- tibble(CB_var_gmax_s = sort(CB_vars),
                   SB_var_gmax_s = sort(SB_vars))
CBSB_all_stab <- all_stab %>%
  right_join(for_join)  %>%
  ungroup() %>%
  mutate(var_treat = "CB-SB",
         var_gmax = CB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax)) %>%
  filter(PB_var_gmax_s == 0)

for_join <- tibble(CB_var_gmax_s = sort(CB_vars),
                   PB_var_gmax_s = sort(PB_vars))
CBPB_all_stab <- all_stab %>%
  right_join(for_join)  %>%
  ungroup() %>%
  mutate(var_treat = "CB-PB",
         var_gmax = CB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax)) %>%
  filter(SB_var_gmax_s == 0)

for_join <- tibble(SB_var_gmax_s = sort(SB_vars),
                   PB_var_gmax_s = sort(PB_vars))
SBPB_all_stab <- all_stab %>%
  right_join(for_join)  %>%
  ungroup() %>%
  mutate(var_treat = "SB-PB",
         var_gmax = SB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax)) %>%
  filter(CB_var_gmax_s == 0)



for_join <- tibble(CB_var_gmax_s = sort(CB_vars),
                   SB_var_gmax_s = sort(SB_vars),
                   PB_var_gmax_s = sort(PB_vars))
CBSBPB_all_stab <- all_stab %>%
  right_join(for_join)  %>%
  ungroup() %>%
  mutate(var_treat = "CB-SB-PB",
         var_gmax = CB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax))

all_stab_results <- CB_all_stab %>%
  bind_rows(SB_all_stab) %>%
  bind_rows(PB_all_stab) %>%
  bind_rows(CBSB_all_stab) %>%
  bind_rows(CBPB_all_stab) %>%
  bind_rows(SBPB_all_stab) %>%
  bind_rows(CBSBPB_all_stab)

all_stab_results <- all_stab_results %>%
  mutate(var_treat = forcats::fct_relevel(var_treat, levels = c("CB",
                                                                "SB",
                                                                "PB",
                                                                "CB-SB",
                                                                "CB-PB",
                                                                "SB-PB",
                                                                "CB-SB-PB")))

all_stab_results_small <- select(all_stab_results, -7:-12)

#saveRDS(all_stab_results_small, here("experiments/0_ss_finding/temporal_method/data/all_stab_results_small.RDS"))



all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(num_strains == 9) %>%
  filter(Species == "SB_tot") %>%
  ggplot(aes(x = stand_var,
             #col = as.factor(num_strains)
             )) +
  geom_line(aes(y = hyst_min_log), lwd = 0.5, alpha = 0.8) +
  geom_line(aes(y = hyst_max_log), lwd = 0.5, alpha = 0.8) +
  geom_ribbon(aes(ymin = hyst_min_log, ymax = hyst_max_log), col = "gray", alpha = 0.2) +
  facet_wrap( ~ var_treat, scales = "free_y", nrow = 3) +
  xlab("Standardised amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[log10 uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") +
  coord_flip() +
  guides(col = guide_legend(title="Number of strains")) +
  theme_bw() +
  theme(
    legend.position="top",
    panel.background = element_blank(),
    #strip.text.x = element_blank()
  ) +
  geom_hline(yintercept = c(-8, 0), col = "grey", lwd = 3) +
  ggtitle("Bistability region for total SB density")

#ggsave(here("experiments/1_figures_main_ms/figure_5_v2_9strain_only.pdf"),
#       width = 10, height = 8)



```






## Effect of simulation duration

### A case where 1'000'000 hours is not long enough

The results below show the stable states as a function of oxygen diffusivity for a system with intermediate level of diversity in all functional groups, with either 1'000'000 hours simulation time, or 2'000'000 hours. This shows that except very close to the values of oxygen diffusitivity at which a state transition occurs, 1'000'000 hours duration of the simulations is sufficient to reach stable state, or very close to it. Very close to the transitions, even at 2'000'000 hours, the dynamics are still transient, with high tolerance strains at high density, even though they will eventually be outcompeted by low tolerance (higher growth rate) strains.

Below is Figure 3 from the main manuscript, in which the duration at each oxygen diffusivity value is 1e6:
 
```{r echo = FALSE, fig.height=10}

single_1e6 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/single_1e6_result.RDS"))
# sort(unique(ss_9s$CB_var_gmax_s))
# sort(unique(ss_9s$SB_var_gmax_s))
# ss_result <- ss_9s %>%
#   filter(abs(CB_var_gmax_s - 0.028254848) < 0.0001,
#          abs(SB_var_gmax_s - 0.084764545) < 0.0001,
#          abs(PB_var_gmax_s - 0.084764545) < 0.0001)

temp <- single_1e6 %>%
  mutate(a = 10^a_O) %>%
  # arrange(a) %>%
  # mutate(direction = rep(c("up", "down"), nrow(ss_result)/2)) %>%
  #mutate(direction = ifelse(initial_N_CB == 1, "up", "down")) %>%
  # select(-initial_N_CB, -a_O) %>%
  gather(species, quantity, 2:(ncol(.) - 2)) %>%
  mutate(
    var_type = ifelse(grepl("B_", species), "Organism", "Substrate"),
    functional_group = case_when(
      str_detect(species, "CB_") ~ "CB",
      str_detect(species, "SB_") ~ "SB",
      str_detect(species, "PB_") ~ "PB"
    ),
    log10_quantity = log10(quantity + 1)
  )

num_strains <- temp %>%
  group_by(functional_group) %>%
  summarise(num = length(unique(species))) %>%
  na.omit()

num_CB_strains <- num_strains$num[num_strains$functional_group == "CB"]
num_SB_strains <- num_strains$num[num_strains$functional_group == "SB"]
num_PB_strains <- num_strains$num[num_strains$functional_group == "PB"]

line_width <- 1

p1 <- temp %>%
  dplyr::filter(functional_group == "CB")  %>%
  mutate(species = factor(species, levels = unique(species))) %>%
  ggplot(aes(x = log10(a), y = log10_quantity, col = species)) +
  geom_path(lwd = line_width) +
  ##ylab("log10(quantity [cells])") +
  ylab("Log(Quantity)") +
  xlab("Oxygen diffusivity") +
  scale_colour_manual(values = colfunc_CB(num_CB_strains)) +
  guides(colour = guide_legend(ncol = 3)) +
  theme(legend.position="none") +
  ggtitle("(b) Cyanobacteria")
#p1# p1

p2 <- temp %>%
  dplyr::filter(functional_group == "SB")  %>%
  mutate(species = factor(species, levels = unique(species))) %>%
  ggplot(aes(x = log10(a), y = log10_quantity, col = species)) +
  geom_path(lwd = line_width) +
  ##ylab("log10(quantity [cells])") +
  ylab("Log(Quantity)") +
  xlab("Oxygen diffusivity") +
  scale_colour_manual(values = colfunc_SB(num_SB_strains)) +
  guides(colour = guide_legend(ncol = 3)) +
  theme(legend.position="none") +
  ggtitle("(c) Sulfate reducing bacteria")

p3 <- temp %>%
  dplyr::filter(functional_group == "PB")  %>%
  mutate(species = factor(species, levels = unique(species))) %>%
  ggplot(aes(x = log10(a), y = log10_quantity, col = species)) +
  geom_path(lwd = line_width) +
  ##ylab("log10(quantity [cells])") +
  ylab("Log(Quantity)") +
  xlab("Oxygen diffusivity") +
  scale_colour_manual(values = colfunc_PB(num_PB_strains)) +
  guides(colour = guide_legend(ncol = 3)) +
  theme(legend.position="none") +
  ggtitle("(d) Phototrophic sulfur bacteria")

p4 <- temp %>%
  dplyr::filter(var_type == "Substrate", species == "O") %>%
  ggplot(aes(x = log10(a), y = log10_quantity, col = species)) +
  geom_path(lwd = line_width) +
  ##ylab("log10(quantity [cells])") +
  ylab("Log(Quantity)") +
  xlab("Oxygen diffusivity") +
  theme(legend.position="none") +
  ggtitle("(e) Oxygen concentration")

p5 <- temp %>%
  dplyr::filter(var_type == "Substrate", species == "SR") %>%
  ggplot(aes(x = log10(a), y = log10_quantity, col = species)) +
  geom_path(lwd = line_width, col = 6) +
  ##ylab("log10(quantity [cells])") +
  ylab("Log(Quantity)") +
  xlab("Oxygen diffusivity") +
  theme(legend.position="none") +
  ggtitle("(f) Sulfide concentration")

patchwork <- p1 / p2 / p3 / p4 / p5
patchwork
```
 
 
 
For comparison, here are the results with twice the duration at each oxygen diffusivity:
 
```{r echo = FALSE, fig.height=10}

single_2e6 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/single_2e6_result.RDS"))
# sort(unique(ss_9s$CB_var_gmax_s))
# sort(unique(ss_9s$SB_var_gmax_s))
# ss_result <- ss_9s %>%
#   filter(abs(CB_var_gmax_s - 0.028254848) < 0.0001,
#          abs(SB_var_gmax_s - 0.084764545) < 0.0001,
#          abs(PB_var_gmax_s - 0.084764545) < 0.0001)

temp <- single_2e6 %>%
  mutate(a = 10^a_O) %>%
  # arrange(a) %>%
  # mutate(direction = rep(c("up", "down"), nrow(ss_result)/2)) %>%
  #mutate(direction = ifelse(initial_N_CB == 1, "up", "down")) %>%
  # select(-initial_N_CB, -a_O) %>%
  gather(species, quantity, 2:(ncol(.) - 2)) %>%
  mutate(
    var_type = ifelse(grepl("B_", species), "Organism", "Substrate"),
    functional_group = case_when(
      str_detect(species, "CB_") ~ "CB",
      str_detect(species, "SB_") ~ "SB",
      str_detect(species, "PB_") ~ "PB"
    ),
    log10_quantity = log10(quantity + 1)
  )

num_strains <- temp %>%
  group_by(functional_group) %>%
  summarise(num = length(unique(species))) %>%
  na.omit()

num_CB_strains <- num_strains$num[num_strains$functional_group == "CB"]
num_SB_strains <- num_strains$num[num_strains$functional_group == "SB"]
num_PB_strains <- num_strains$num[num_strains$functional_group == "PB"]

line_width <- 1

p1 <- temp %>%
  dplyr::filter(functional_group == "CB")  %>%
  mutate(species = factor(species, levels = unique(species))) %>%
  ggplot(aes(x = log10(a), y = log10_quantity, col = species)) +
  geom_path(lwd = line_width) +
  ##ylab("log10(quantity [cells])") +
  ylab("Log(Quantity)") +
  xlab("Oxygen diffusivity") +
  scale_colour_manual(values = colfunc_CB(num_CB_strains)) +
  guides(colour = guide_legend(ncol = 3)) +
  theme(legend.position="none") +
  ggtitle("(b) Cyanobacteria")
#p1# p1

p2 <- temp %>%
  dplyr::filter(functional_group == "SB")  %>%
  mutate(species = factor(species, levels = unique(species))) %>%
  ggplot(aes(x = log10(a), y = log10_quantity, col = species)) +
  geom_path(lwd = line_width) +
  ##ylab("log10(quantity [cells])") +
  ylab("Log(Quantity)") +
  xlab("Oxygen diffusivity") +
  scale_colour_manual(values = colfunc_SB(num_SB_strains)) +
  guides(colour = guide_legend(ncol = 3)) +
  theme(legend.position="none") +
  ggtitle("(c) Sulfate reducing bacteria")

p3 <- temp %>%
  dplyr::filter(functional_group == "PB")  %>%
  mutate(species = factor(species, levels = unique(species))) %>%
  ggplot(aes(x = log10(a), y = log10_quantity, col = species)) +
  geom_path(lwd = line_width) +
  ##ylab("log10(quantity [cells])") +
  ylab("Log(Quantity)") +
  xlab("Oxygen diffusivity") +
  scale_colour_manual(values = colfunc_PB(num_PB_strains)) +
  guides(colour = guide_legend(ncol = 3)) +
  theme(legend.position="none") +
  ggtitle("(d) Phototrophic sulfur bacteria")

p4 <- temp %>%
  dplyr::filter(var_type == "Substrate", species == "O") %>%
  ggplot(aes(x = log10(a), y = log10_quantity, col = species)) +
  geom_path(lwd = line_width) +
  ##ylab("log10(quantity [cells])") +
  ylab("Log(Quantity)") +
  xlab("Oxygen diffusivity") +
  theme(legend.position="none") +
  ggtitle("(e) Oxygen concentration")

p5 <- temp %>%
  dplyr::filter(var_type == "Substrate", species == "SR") %>%
  ggplot(aes(x = log10(a), y = log10_quantity, col = species)) +
  geom_path(lwd = line_width, col = 6) +
  ##ylab("log10(quantity [cells])") +
  ylab("Log(Quantity)") +
  xlab("Oxygen diffusivity") +
  theme(legend.position="none") +
  ggtitle("(f) Sulfide concentration")

patchwork <- p1 / p2 / p3 / p4 / p5
patchwork
```
 
### Shorter simulation times

Here 1e4 hours at each oxygen diffusivity level:

```{r}
## Figure 5 ----
## Region of bistability by diversity and number of strains.

# ss_2s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/2_strain_SS_data_1e6.RDS"))
# stab_2s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/2_strain_stab_data_1e6.RDS")) %>%
#   mutate(num_strains = 2)
# ss_2s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/2_strain_SS_data_1e6_sub1.RDS"))
# stab_2s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/2_strain_stab_data_1e6_sub1.RDS")) %>%
#   mutate(num_strains = 2)
# 
# 
# ss_3s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/3_strain_SS_data_1e6.RDS"))
# stab_3s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/3_strain_stab_data_1e6.RDS")) %>%
#   mutate(num_strains = 3) 
# ss_3s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/3_strain_SS_data_1e6_sub1.RDS"))
# stab_3s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/3_strain_stab_data_1e6_sub1.RDS")) %>%
#   mutate(num_strains = 3)
# 
# 
# 
# 
# ss_6s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/6_strain_SS_data_1e6.RDS"))
# stab_6s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/6_strain_stab_data_1e6.RDS")) %>%
#   mutate(num_strains = 6) 
# ss_6s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/6_strain_SS_data_1e6_sub1.RDS"))
# stab_6s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/6_strain_stab_data_1e6_sub1.RDS")) %>%
#   mutate(num_strains = 6)
# 

# expt_res <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_SS_data_1e6_eventdef2.RDS"))
# num_cores <- 8
# expt_res <- expt_res %>%
#   mutate(ssfind_result = list(get_total_bio(ssfind_result)))
# cluster1 <- multidplyr::new_cluster(num_cores)
# multidplyr::cluster_library(cluster1, c("microxanox", "dplyr"))
# system.time({
#   stab_data <-  expt_res %>%
#     multidplyr::partition(cluster1) %>%
#     mutate(stability_measures = list(get_stability_measures_new(ssfind_result))) %>%
#     collect() %>%
#     unnest(cols = c(stability_measures)) 
# })
# saveRDS(stab_data, here("experiments/0_ss_finding/temporal_method/data/9_strain_stab_data_1e6_eventdef2.RDS"))

#stab_9s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_stab_data_1e6_eventdef2.RDS")) %>%
#  mutate(num_strains = 9) 

stab_9s <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_stab_data_1e4_eventdef2.RDS")) %>%
  mutate(num_strains = 9) 


#ss_9s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_SS_data_1e6_sub1.RDS"))
#stab_9s_sub1 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_stab_data_1e6_sub1.RDS")) %>%
#  mutate(num_strains = 9)

#stab_9s_diff3 <- readRDS(here("experiments/0_ss_finding/temporal_method/data/9_strain_stab_data_1e6_diff3.RDS")) %>%
#  mutate(num_strains = 9) 


# all_stab <- stab_2s %>%
#   bind_rows(stab_2s_sub1) %>%
#   bind_rows(stab_3s) %>%
#   bind_rows(stab_3s_sub1) %>%
#   bind_rows(stab_6s) %>%
#   bind_rows(stab_6s_sub1) %>%
#   bind_rows(stab_9s) %>%
#   bind_rows(stab_9s_sub1) %>%
#   bind_rows(stab_9s_diff3)

all_stab <- stab_9s

CB_vars <- unique(all_stab$CB_var_gmax_s)
SB_vars <- unique(all_stab$SB_var_gmax_s)
PB_vars <- unique(all_stab$PB_var_gmax_s)

CB_all_stab <- all_stab %>%
  filter(SB_var_gmax_s == 0,
         PB_var_gmax_s == 0) %>%
  ungroup() %>%
  mutate(var_treat = "CB",
         var_gmax = CB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax))
SB_all_stab <- all_stab %>%
  filter(CB_var_gmax_s == 0,
         PB_var_gmax_s == 0)  %>%
  ungroup() %>%
  mutate(var_treat = "SB",
         var_gmax = SB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax))
PB_all_stab <- all_stab %>%
  filter(CB_var_gmax_s == 0,
         SB_var_gmax_s == 0) %>%
  ungroup()  %>%
  mutate(var_treat = "PB",
         var_gmax = PB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax))

for_join <- tibble(CB_var_gmax_s = sort(CB_vars),
                   SB_var_gmax_s = sort(SB_vars))
CBSB_all_stab <- all_stab %>%
  right_join(for_join)  %>%
  ungroup() %>%
  mutate(var_treat = "CB-SB",
         var_gmax = CB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax)) %>%
  filter(PB_var_gmax_s == 0)

for_join <- tibble(CB_var_gmax_s = sort(CB_vars),
                   PB_var_gmax_s = sort(PB_vars))
CBPB_all_stab <- all_stab %>%
  right_join(for_join)  %>%
  ungroup() %>%
  mutate(var_treat = "CB-PB",
         var_gmax = CB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax)) %>%
  filter(SB_var_gmax_s == 0)

for_join <- tibble(SB_var_gmax_s = sort(SB_vars),
                   PB_var_gmax_s = sort(PB_vars))
SBPB_all_stab <- all_stab %>%
  right_join(for_join)  %>%
  ungroup() %>%
  mutate(var_treat = "SB-PB",
         var_gmax = SB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax)) %>%
  filter(CB_var_gmax_s == 0)



for_join <- tibble(CB_var_gmax_s = sort(CB_vars),
                   SB_var_gmax_s = sort(SB_vars),
                   PB_var_gmax_s = sort(PB_vars))
CBSBPB_all_stab <- all_stab %>%
  right_join(for_join)  %>%
  ungroup() %>%
  mutate(var_treat = "CB-SB-PB",
         var_gmax = CB_var_gmax_s,
         stand_var = var_gmax / max(var_gmax))

all_stab_results <- CB_all_stab %>%
  bind_rows(SB_all_stab) %>%
  bind_rows(PB_all_stab) %>%
  bind_rows(CBSB_all_stab) %>%
  bind_rows(CBPB_all_stab) %>%
  bind_rows(SBPB_all_stab) %>%
  bind_rows(CBSBPB_all_stab)

all_stab_results <- all_stab_results %>%
  mutate(var_treat = forcats::fct_relevel(var_treat, levels = c("CB",
                                                                "SB",
                                                                "PB",
                                                                "CB-SB",
                                                                "CB-PB",
                                                                "SB-PB",
                                                                "CB-SB-PB")))

all_stab_results_small <- select(all_stab_results, -7:-12)

#saveRDS(all_stab_results_small, here("experiments/0_ss_finding/temporal_method/data/all_stab_results_small.RDS"))



all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(num_strains == 9) %>%
  filter(Species == "SB_tot") %>%
  ggplot(aes(x = stand_var,
             #col = as.factor(num_strains)
             )) +
  geom_line(aes(y = hyst_min_log), lwd = 0.5, alpha = 0.8) +
  geom_line(aes(y = hyst_max_log), lwd = 0.5, alpha = 0.8) +
  geom_ribbon(aes(ymin = hyst_min_log, ymax = hyst_max_log), col = "gray", alpha = 0.2) +
  facet_wrap( ~ var_treat, scales = "free_y", nrow = 3) +
  xlab("Standardised amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[log10 uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") +
  coord_flip() +
  guides(col = guide_legend(title="Number of strains")) +
  theme_bw() +
  theme(
    legend.position="top",
    panel.background = element_blank(),
    #strip.text.x = element_blank()
  ) +
  geom_hline(yintercept = c(-8, 0), col = "grey", lwd = 3) +
  ggtitle("Bistability region for total SB density")

#ggsave(here("experiments/1_figures_main_ms/figure_5_v2_9strain_only.pdf"),
#       width = 10, height = 8)



```


 

# Finding the separatrix

In the original publication ([Bush et al 2017](<https://www.nature.com/articles/s41467-017-00912-x>)) Figure 3a shows a separatrix in the cyanobacteria abundance - oxygen diffusivity dimensions of the system. If the system has initial cyanobacterial abundance greater than the value at the separatrix then the cyanobacterial abundance increases, and the system goes to the oxic stable state. Conversely, if the system has initial cyanobacterial abundance greater than the value at the separatrix then the cyanobacterial abundance decreases, and the system goes to the anoxic stable state.

It is critical to note, however, that the position of the separatrix depends on both the parameters of the system, and the initial conditions of variables other than cyanobacterial abundance. If the system were started with higher initial concentration, then the position of the separatrix would change (as would the values of oxygen diffusivity at which the system tipped from anoxic to oxic, and from oxic to anoxic).

This issue of dependence of the position of the separatrix on the value of initial condition of multiple state variables has particular significance when there are multiple strains per functional group. Then one cannot just vary initial total cyanobacterial abundance (as was done to create the separatrix on Figure 3a in the original publication) but one must also define how the initial abundance of each of the strains varies. One might choose to make each strain have equal initial abundance, and to vary the total (as we did in our implementation of the replication method in the main article).

We could, however, and arguably should, give the most tolerant strain of cyanobacteria higher initial relative abundance when total initial cyanobacterial abundance was low, and the least tolerant strain higher initial relative abundance when total cyanobacterial abundance was high. And we would need to specify the total and relative abundance of all cyanobacteria (and sulfur bactria) strains. Thus, with a system as complex as the 9 strain system, which has 31 state variables the separatrix is very high dimensional, and evaluating (and plotting) it in one dimension requires many assumption. We chose to not attempt to find a meaningful set of assumptions in this study, though not because we think it would be unprofitable to do so, but rather because we did not want to risk distracting attention from findings we consider to be significant enough in the own right.



