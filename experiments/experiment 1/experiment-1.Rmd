---
title: "experiment 1"
author: "Owen Petchey"
date: "6/25/2021"
output:
  pdf_document: default
  html_document:
    keep_md: yes
---

This experiment supercedes all previous ones.
It is a factorial manipulation of diversity of the three groups.
It takes about 50 hours to run while using 12 cores.


# Setup

## R

```{r}


rm(list = ls())

knitr::opts_knit$set(progress = TRUE, verbose = FALSE, cache = TRUE)

microxanox_release <- "0.2"

#tmplib <- tempfile()
#dir.create(tmplib)


### From '?remotes::install_github`:
# auth_token	
#   To install from a private repo, generate a personal access token (PAT) in
#   "https://github.com/settings/tokens" and supply to this argument. This is 
#   safer than using a password because you can easily delete a PAT without 
#   affecting any others. Defaults to the GITHUB_PAT environment variable.

# remotes::install_github(
#   "opetchey/microxanox",
#   ref = microxanox_release,
#   # auth_token = "ENTER YOUR TOKEN or PROVED AS ENVIRONMENT VARIABLE",
#   build_vignettes = FALSE,
#   force = TRUE,
#   upgrade = FALSE,
#   lib = tmplib
# )

#library(microxanox, lib.loc = tmplib)

library(microxanox)
library(tidyverse)
library(patchwork)
library(here)
source(here("experiments/r functions/various_useful_functions.r"))
zero <- 0 ## don't change
unity <- 1 ## don't change!!!
#options(mc.cores = 8)
eval_dynamics_flag <- FALSE
```

## Version of `microxanox` package used: `r packageVersion("microxanox") `

## General simulation conditions

```{r}
default_dynamic_model <- bushplus_dynamic_model
default_event_definition <- event_definition_1
default_event_interval <- 100
default_noise_sigma <- 0
default_minimum_abundances <- rep(1, 3)
names(default_minimum_abundances) <- c("CB", "PB", "SB")
default_sim_duration <- 80000
default_sim_sample_interval <- 100
initial_pars_from <- "bush_ssfig3"
## note that next line (log10a_series is over-ridden with getting stable states)
#default_log10a_series <- c(-2, -2, -2, -2, -10, -10, -10, -10, -10)
```


## Define diversity

```{r}
num_CB_strains <- 9
num_SB_strains <- 9
num_PB_strains <- 9

## multiplier of SBPB variation
CB_var_multiplier <- 2
SBPB_var_multiplier <- 6

CB_gmax_div <- 0.015789474 * CB_var_multiplier
CB_h_div <- -0.08 * CB_var_multiplier
SB_gmax_div <- 0.015789474 * SBPB_var_multiplier
SB_h_div <- -0.323  * SBPB_var_multiplier
PB_gmax_div <- 0.015789474  * SBPB_var_multiplier
PB_h_div <- -0.323  * SBPB_var_multiplier

num_div_treatment_levels <- 20
```

## Create diversity

```{r}
var_expt <- create_diversity_factorial()
```

## Display diversity

```{r}
display_diversity(400)
```



# Temporal switching


```{r}
var_expt_levels <- var_expt[,1:6]

no_diversity <- which(rowSums(abs(var_expt_levels))==0)
max_diversty_all <- which(max(rowSums(abs(var_expt_levels))) ==
                            rowSums(abs(var_expt_levels)))
max_only_CB_diversity <- which(max(rowSums(abs(var_expt_levels[,1:2]))) ==
                            rowSums(abs(var_expt_levels[,1:2])) &
                              rowSums(abs(var_expt_levels[,3:6]))==0)
#var_expt_levels[381,]

max_only_SBPB_diversity <- which(max(rowSums(abs(var_expt_levels[,3:6]))) ==
                            rowSums(abs(var_expt_levels[,3:6])) &
                              rowSums(abs(var_expt_levels[,1:2]))==0)
#var_expt_levels[20,]

```




## Oxic to anoxic

### No diversity

```{r eval = eval_dynamics_flag}
default_sim_duration <- 80000
```

```{r eval = eval_dynamics_flag}
default_log10a_series <- c(-1, -7, -7)
initial_state <- new_initial_state(num_CB_strains,
                                   num_PB_strains,
                                   num_SB_strains,
                                   values = "bush_ssfig3")
initial_state[grep("CB_", names(initial_state))] <- 10^10/num_CB_strains
sim_res_novar1 <- run_simulation(parameter_values = var_expt$pars[[no_diversity]],
                          initial_state = initial_state)
saveRDS(sim_res_novar1, here("experiments/experiment 1/data/sim_res_novar1.RDS"))
```


```{r}
sim_res_novar1 <- readRDS(here("experiments/experiment 1/data/sim_res_novar1.RDS"))
plot_dynamics(sim_res_novar1)
#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)
```

### Maximum diversity

```{r eval = eval_dynamics_flag}
sim_number <- num_div_treatment_levels
sim_res_highvar1 <- run_simulation(parameter_values = var_expt$pars[[max_diversty_all]],
                          initial_state = initial_state)
saveRDS(sim_res_highvar1, here("experiments/experiment 1/data/sim_res_highvar1.RDS"))
```


```{r}
sim_res_highvar1 <- readRDS(here("experiments/experiment 1/data/sim_res_highvar1.RDS"))
plot_dynamics(sim_res_highvar1)
#ggsave(here("simulationsexpt2/figures/switching_highvar.pdf"), width = 10)

```

## Anoxic to oxic

### No diversity

```{r eval = eval_dynamics_flag}
default_sim_duration <- 60000
```


```{r eval = eval_dynamics_flag}
sim_number <- 1
default_log10a_series <- c(-5, -3, -1, -1)
initial_state <- new_initial_state(num_CB_strains,
                                   num_PB_strains,
                                   num_SB_strains,
                                   values = "bush_ssfig3")
initial_state[grep("CB_", names(initial_state))] <- 10/num_CB_strains
sim_res_novar2 <- run_simulation(parameter_values = var_expt$pars[[no_diversity]],
                          initial_state = initial_state)
saveRDS(sim_res_novar2, here("experiments/experiment 1/data/sim_res_novar2.RDS"))
```


```{r}
sim_res_novar2 <- readRDS(here("experiments/experiment 1/data/sim_res_novar2.RDS"))
plot_dynamics(sim_res_novar2)
#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)
```

### Maximum diversity

```{r eval = eval_dynamics_flag}
sim_number <- num_div_treatment_levels
sim_res_highvar2 <- run_simulation(parameter_values = var_expt$pars[[max_diversty_all]],
                          initial_state = initial_state)
saveRDS(sim_res_highvar2, here("experiments/experiment 1/data/sim_res_highvar2.RDS"))
```


```{r}
sim_res_highvar2 <- readRDS(here("experiments/experiment 1/data/sim_res_highvar2.RDS"))
plot_dynamics(sim_res_highvar2)
#ggsave(here("simulationsexpt2/figures/switching_highvar.pdf"), width = 10)

```


## Anoxic to oxic to anoxic

### No diversity

```{r eval = eval_dynamics_flag}
default_sim_duration <- 1000000
```

```{r eval = eval_dynamics_flag}
default_minimum_abundances <- rep(100, 3)
names(default_minimum_abundances) <- c("CB", "PB", "SB")
```

```{r eval = eval_dynamics_flag}
sim_number1 <- 1
default_log10a_series <- c(-1, -8, -1)
initial_state <- new_initial_state(num_CB_strains,
                                   num_PB_strains,
                                   num_SB_strains,
                                   values = "bush_ssfig3")
initial_state[grep("CB_", names(initial_state))] <- 10/num_CB_strains
sim_res_novar3 <- run_simulation(parameter_values = var_expt$pars[[no_diversity]],
                          initial_state = initial_state)
saveRDS(sim_res_novar3, here("experiments/experiment 1/data/sim_res_novar3.RDS"))
```


```{r}
sim_res_novar3 <- readRDS(here("experiments/experiment 1/data/sim_res_novar3.RDS"))
plot_dynamics(sim_res_novar3)
#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)
```

### Medium diversity

```{r eval = eval_dynamics_flag}
sim_number2 <- num_div_treatment_levels
try_me <- 311
sim_res_highvar3 <- run_simulation(parameter_values =
                                     var_expt$pars[[try_me]],
                          initial_state = initial_state)
# sim_res_highvar3 <- run_simulation(parameter_values =
#                                      var_expt$pars[[max_diversty_all]],
#                           initial_state = initial_state)
saveRDS(sim_res_highvar3, here("experiments/experiment 1/data/sim_res_highvar3.RDS"))
```


```{r}
sim_res_highvar3 <- readRDS(here("experiments/experiment 1/data/sim_res_highvar3.RDS"))
plot_dynamics(sim_res_highvar3)
#ggsave(here("simulationsexpt2/figures/switching_highvar.pdf"), width = 10)

```

### Visualise

```{r eval = FALSE}
sim_res_novar <- sim_res_novar3
sim_res_highvar <- sim_res_highvar3
visualise_temporal_env_eco()
```



# Stable state finding

## Finding

```{r}
options(mc.cores = 12)
```


```{r}
default_sim_duration <- 1000000
ssfind_minimum_abundances <- rep(0, 3)
names(ssfind_minimum_abundances) <- c("CB", "PB", "SB")
ssfind_simulation_duration <- default_sim_duration
ssfind_simulation_sampling_interval <- ssfind_simulation_duration
ssfind_event_interval <- ssfind_simulation_duration
grid_num_a <- 1000 #usually 1000 ## number of a_0 values
a_Os <- 10^seq(-7, -0.5, length=grid_num_a) ## sequence of a_0 values
grid_num_N <- 2 ## number of N values
initial_CBs <- 10^seq(0, 10, length=grid_num_N) ## sequence of N values
initial_PBs <- 1e8 ## not varied
initial_SBs <- 1e8 ## not varied
# next line creates all possible combinations
ss_expt <- expand.grid(N_CB = initial_CBs,
                      N_PB = initial_PBs,
                      N_SB = initial_SBs,
                      a_O = a_Os)


```

Run stable state finding

*Careful, this simulation takes about 600 hours on a single core

```{r eval = FALSE}
var_expt <- run_ss_var_experiment()
saveRDS(var_expt, here("experiments/experiment 1/data/ss_data_1e6_x2x6_factorial.RDS"))

```

Process the stable state data

Bring in various stable state datasets
```{r eval = FALSE}
## sim length 80'000, 20 x 20 factorial, reference maximum diversity
var_expt1 <- readRDS(here("experiments/experiment 1/data/ss_data_80000.RDS")) %>%
  mutate(sim_length = 80000)
stab_data1 <- var_expt1 %>%
  group_by(CB_var_gmax_s, CB_var_h_s,
           SB_var_gmax_s, SB_var_h_s,
           PB_var_gmax_s, PB_var_h_s, sim_length) %>%
  do(stability_measures = get_stability_measures(.$ss_res[[1]]))
stab_data1 <- unnest(stab_data1, cols = c(stability_measures))
saveRDS(stab_data1, here("experiments/experiment 1/data/stab_data_80000.RDS"))



## sim length 1'000'000, 20 x 20 factorial, reference maximum diversity
var_expt2 <- readRDS(here("experiments/experiment 1/data/ss_data_1000000_20factorial.RDS")) %>%
  mutate(sim_length = 1000000)
stab_data2 <- var_expt2 %>%
  group_by(CB_var_gmax_s, CB_var_h_s,
           SB_var_gmax_s, SB_var_h_s,
           PB_var_gmax_s, PB_var_h_s, sim_length) %>%
  do(stability_measures = get_stability_measures(.$ss_res[[1]]))
stab_data2 <- unnest(stab_data2, cols = c(stability_measures))
saveRDS(stab_data2, here("experiments/experiment 1/data/stab_data_1000000_20factorial.RDS"))


## sim length 1'000'000, 20 SBPBgrad, 5x maximum diversity
var_expt3 <- readRDS(here("experiments/experiment 1/data/ss_data_1e6_noCB_5xSBPB_.RDS")) %>%
  mutate(sim_length = 1000000)
stab_data3 <- var_expt3 %>%
  group_by(CB_var_gmax_s, CB_var_h_s,
           SB_var_gmax_s, SB_var_h_s,
           PB_var_gmax_s, PB_var_h_s, sim_length) %>%
  do(stability_measures = get_stability_measures(.$ss_res[[1]]))
stab_data3 <- unnest(stab_data3, cols = c(stability_measures))
saveRDS(stab_data3, here("experiments/experiment 1/data/stab_data_1e6_noCB_5xSBPB_.RDS"))


## sim length 300'000, 20 SBPBgrad, reference maximum diversity
var_expt4 <- readRDS(here("experiments/experiment 1/data/ss_data_300000_small.RDS")) %>%
  mutate(sim_length = 300000)
stab_data4 <- var_expt4 %>%
  group_by(CB_var_gmax_s, CB_var_h_s,
           SB_var_gmax_s, SB_var_h_s,
           PB_var_gmax_s, PB_var_h_s, sim_length) %>%
  do(stability_measures = get_stability_measures(.$ss_res[[1]]))
stab_data4 <- unnest(stab_data4, cols = c(stability_measures))
saveRDS(stab_data4, here("experiments/experiment 1/data/stab_data_300000.RDS"))


## sim length 1'000'000, 20 SBPBgrad, 2xCB variation, 6xSBPB variation
var_expt5 <- readRDS(here("experiments/experiment 1/data/ss_data_1e6_x2x6_factorial.RDS")) %>%
  mutate(sim_length = 1000000)
stab_data5 <- var_expt5 %>%
  group_by(CB_var_gmax_s, CB_var_h_s,
           SB_var_gmax_s, SB_var_h_s,
           PB_var_gmax_s, PB_var_h_s, sim_length) %>%
  do(stability_measures = get_stability_measures(.$ss_res[[1]]))
stab_data5 <- unnest(stab_data5, cols = c(stability_measures))
saveRDS(stab_data5, here("experiments/experiment 1/data/stab_data_1e6_x2x6_factorial.RDS"))

```



## SS, no diversity, all diversity, CB only, and SBPB only


```{r}
## find various combinations of diversity
var_expt <- readRDS(here("experiments/experiment 1/data/ss_data_1000000_20factorial.RDS"))

var_expt_levels <- var_expt[,1:6]

no_diversity <- which(rowSums(abs(var_expt_levels))==0)
max_diversty_all <- which(max(rowSums(abs(var_expt_levels))) ==
                            rowSums(abs(var_expt_levels)))
max_only_CB_diversity <- which(max(rowSums(abs(var_expt_levels[,1:2]))) ==
                            rowSums(abs(var_expt_levels[,1:2])) &
                              rowSums(abs(var_expt_levels[,3:6]))==0)
#var_expt_levels[381,]

max_only_SBPB_diversity <- which(max(rowSums(abs(var_expt_levels[,3:6]))) ==
                            rowSums(abs(var_expt_levels[,3:6])) &
                              rowSums(abs(var_expt_levels[,1:2]))==0)
#var_expt_levels[20,]

```


```{r}

p1  <- plot_ss_result1(var_expt,
                result_index = no_diversity,
                filename_prefix = NULL,
                save_image_file = FALSE)
p1


#junk1 <- var_expt[no_diversity,]$ss_res[[1]]
```

```{r}

p2  <- plot_ss_result1(var_expt,
                result_index = max_diversty_all,
                filename_prefix = NULL,
                save_image_file = FALSE)
p2

```

```{r}

p3  <- plot_ss_result1(var_expt,
                result_index = max_only_CB_diversity,
                filename_prefix = NULL,
                save_image_file = FALSE)
p3

```

```{r}

p4  <- plot_ss_result1(var_expt,
                result_index = max_only_SBPB_diversity,
                filename_prefix = NULL,
                save_image_file = FALSE)
p4

```


```{r}
p_overlay1 <- plot_ss_result2(var_expt[no_diversity,]$ss_res[[1]],
                             var_expt[max_diversty_all,]$ss_res[[1]],
                             xlims = c(-7, -1))
p_overlay1
```

```{r}
p_overlay2 <- plot_ss_result2(var_expt[no_diversity,]$ss_res[[1]],
                             var_expt[max_only_CB_diversity,]$ss_res[[1]],
                             xlims = c(-7, -1))
p_overlay2

#ss_result1 <- var_expt[no_diversity,]$ss_res[[1]]
#ss_result2 <- var_expt[max_only_CB_diversity,]$ss_res[[1]]

```

```{r}
p_overlay3 <- plot_ss_result2(var_expt[no_diversity,]$ss_res[[1]],
                             var_expt[max_only_SBPB_diversity,]$ss_res[[1]],
                             xlims = c(-7, -1))
p_overlay3


#ss_result3 <- var_expt[max_only_SBPB_diversity,]$ss_res[[1]]


```

## Look at stability measures

```{r}
stab_data1 <- readRDS(here("experiments/experiment 1/data/stab_data_1000000_20factorial.RDS"))
stab_data2 <- readRDS(here("experiments/experiment 1/data/stab_data_80000.RDS"))
stab_data <- bind_rows(stab_data1, stab_data2) 

CB_vars <- unique(stab_data$CB_var_gmax_s)
SB_vars <- unique(stab_data$CB_var_gmax_s)

CB_stab_data <- stab_data %>%
  filter(SB_var_gmax_s == 0) %>%
  mutate(var_treat = "CB",
         var_gmax = CB_var_gmax_s)

SBPB_stab_data <- stab_data %>%
  filter(CB_var_gmax_s == 0) %>%
  mutate(var_treat = "SB-PB",
         var_gmax = SB_var_gmax_s)

for_join <- tibble(CB_var_gmax_s = CB_vars,
                     SB_var_gmax_s = SB_vars)
CBSBPB_stab_data <- stab_data %>%
  right_join(for_join) %>%
  mutate(var_treat = "CB-SB-PB",
         var_gmax = CB_var_gmax_s)

all_stab_results <- CB_stab_data %>%
  bind_rows(SBPB_stab_data) %>%
#  bind_rows(results3) %>%
 # bind_rows(results4) %>%
  bind_rows(CBSBPB_stab_data)

all_stab_results<- all_stab_results %>%
    mutate(var_treat = forcats::fct_relevel(var_treat, levels = c("CB", "SB-PB", "CB-SB-PB")))

saveRDS(all_stab_results, here("experiments/experiment 1/data/all_stab.RDS"))

```

### Raw Stability
```{r plot1_raw}
all_stab_results <- readRDS(here("experiments/experiment 1/data/all_stab.RDS"))

all_stab_results %>%
  filter(Species == "O") %>%
  ggplot(aes(x = var_gmax, y = hyst_range_raw, col=var_treat, shape = as_factor(sim_length))) +
  geom_point() +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Extent of bistability region\n[oxygen diffusivity]") +
  labs(col = "Variation in\nonly these\nfunctional groups")
##ggsave("manuscript/figures/extent_of_bistab1.pdf", height = 4)

all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = var_gmax,
             ymin = hyst_min_raw,
             ymax = hyst_max_raw,
             fill=var_treat)) +
  geom_ribbon(alpha = 0.5) +
  facet_wrap( ~ var_treat, nrow = 3) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") + 
  coord_flip() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )

all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "O",
         sim_length == 8e4) %>%
  ggplot(aes(x = var_gmax,
             ymin = hyst_min_raw,
             ymax = hyst_max_raw,
             fill=var_treat)) +
  geom_ribbon(alpha = 0.5) +
  facet_wrap( ~ var_treat, nrow = 3) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") + 
  coord_flip() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )



##ggsave("manuscript/figures/extent_of_bistab2.pdf", height = 4)
stab_data1 <- readRDS(here("experiments/experiment 1/data/stab_data_1000000_20factorial.RDS"))
stab_data_x <- readRDS(here("experiments/experiment 1/data/stab_data_1e6_noCB_5xSBPB_.RDS"))
stab_data_plus <- bind_rows(stab_data1, stab_data_x)
stab_data_plus %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = CB_var_gmax_s, y = SB_var_gmax_s, fill = hyst_range_raw, col = hyst_range_raw)) +
  geom_point(size = 3)
```


### Log Stability
```{r plot1_log}
all_stab_results <- readRDS(here("experiments/experiment 1/data/all_stab.RDS"))

all_stab_results %>%
  filter(Species == "O") %>%
  ggplot(aes(x = var_gmax, y = hyst_range_log, col=var_treat, shape = as_factor(sim_length))) +
  geom_point() +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Extent of bistability region\n[log10 oxygen diffusivity]") +
  labs(col = "Variation in\nonly these\nfunctional groups")
##ggsave("manuscript/figures/extent_of_bistab1.pdf", height = 4)

all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = var_gmax,
             ymin = hyst_min_log,
             ymax = hyst_max_log,
             fill=var_treat)) +
  geom_ribbon(alpha = 0.5) +
  facet_wrap( ~ var_treat, nrow = 3) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[log10 uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") + 
  coord_flip() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )

all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "O",
         sim_length == 8e4) %>%
  ggplot(aes(x = var_gmax,
             ymin = hyst_min_log,
             ymax = hyst_max_log,
             fill=var_treat)) +
  geom_ribbon(alpha = 0.5) +
  facet_wrap( ~ var_treat, nrow = 3) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[log10 uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") + 
  coord_flip() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )



##ggsave("manuscript/figures/extent_of_bistab2.pdf", height = 4)
stab_data1 <- readRDS(here("experiments/experiment 1/data/stab_data_1000000_20factorial.RDS"))
stab_data_x <- readRDS(here("experiments/experiment 1/data/stab_data_1e6_noCB_5xSBPB_.RDS"))
stab_data_plus <- bind_rows(stab_data1, stab_data_x)
stab_data_plus %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = CB_var_gmax_s, y = SB_var_gmax_s, fill = hyst_range_log, col = hyst_range_log)) +
  geom_point(size = 3)
```

## Extra SBPB diversity


```{r}
var_expt_x <- readRDS(here("experiments/experiment 1/data/ss_data_1e6_noCB_5xSBPB_.RDS"))
stab_data_x <- readRDS(here("experiments/experiment 1/data/stab_data_1e6_noCB_5xSBPB_.RDS"))


p1  <- plot_ss_result1(var_expt_x,
                result_index = 1,
                filename_prefix = NULL,
                save_image_file = FALSE)
p1

p1  <- plot_ss_result1(var_expt_x,
                result_index = 19,
                filename_prefix = NULL,
                save_image_file = FALSE)
p1

p_overlay1 <- plot_ss_result2(var_expt_x[1,]$ss_res[[1]],
                             var_expt_x[19,]$ss_res[[1]],
                             xlims = c(-7, -1))
p_overlay1
```

### Raw Stability
 
```{r}
stab_data_x %>%
  filter(Species == "O") %>%
  ggplot(aes(x = SB_var_gmax_s, y = hyst_range_raw)) +
  geom_point() +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Extent of bistability region\n[oxygen diffusivity]") +
  labs(col = "Variation in\nonly these\nfunctional groups")
##ggsave("manuscript/figures/extent_of_bistab1.pdf", height = 4)

stab_data_x %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "O") %>%
  ggplot(aes(x = SB_var_gmax_s,
             ymin = hyst_min_raw,
             ymax = hyst_max_raw)) +
  geom_ribbon(alpha = 0.5) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[uM per hour]") +
  coord_flip() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )
```


### Log Stability
```{r}

stab_data_x %>%
  filter(Species == "O") %>%
  ggplot(aes(x = SB_var_gmax_s, y = hyst_range_log)) +
  geom_point() +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Extent of bistability region\n[log10 oxygen diffusivity]") +
  labs(col = "Variation in\nonly these\nfunctional groups")
##ggsave("manuscript/figures/extent_of_bistab1.pdf", height = 4)

stab_data_x %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "O") %>%
  ggplot(aes(x = SB_var_gmax_s,
             ymin = hyst_min_log,
             ymax = hyst_max_log)) +
  geom_ribbon(alpha = 0.5) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[log10 uM per hour]") +
  coord_flip() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )
```


## 2x CB, 6xSBPB diversity

```{r}
## find various combinations of diversity
var_expt <- readRDS(here("experiments/experiment 1/data/ss_data_1e6_x2x6_factorial.RDS"))
stab_data <- readRDS(here("experiments/experiment 1/data/stab_data_1e6_x2x6_factorial.RDS"))

var_expt_levels <- var_expt[,1:6]

no_diversity <- which(rowSums(abs(var_expt_levels))==0)
max_diversty_all <- which(max(rowSums(abs(var_expt_levels))) ==
                            rowSums(abs(var_expt_levels)))
max_only_CB_diversity <- which(max(rowSums(abs(var_expt_levels[,1:2]))) ==
                            rowSums(abs(var_expt_levels[,1:2])) &
                              rowSums(abs(var_expt_levels[,3:6]))==0)
#var_expt_levels[381,]

max_only_SBPB_diversity <- which(max(rowSums(abs(var_expt_levels[,3:6]))) ==
                            rowSums(abs(var_expt_levels[,3:6])) &
                              rowSums(abs(var_expt_levels[,1:2]))==0)
#var_expt_levels[20,]

```


```{r}

p1  <- plot_ss_result1(var_expt,
                result_index = no_diversity,
                filename_prefix = NULL,
                save_image_file = FALSE)
p1


#junk1 <- var_expt[no_diversity,]$ss_res[[1]]
```

```{r}

p2  <- plot_ss_result1(var_expt,
                result_index = max_diversty_all,
                filename_prefix = NULL,
                save_image_file = FALSE)
p2

```

```{r}

p3  <- plot_ss_result1(var_expt,
                result_index = max_only_CB_diversity,
                filename_prefix = NULL,
                save_image_file = FALSE)
p3

```

```{r}

p4  <- plot_ss_result1(var_expt,
                result_index = max_only_SBPB_diversity,
                filename_prefix = NULL,
                save_image_file = FALSE)
p4

```


```{r}
p_overlay1 <- plot_ss_result2(var_expt[no_diversity,]$ss_res[[1]],
                             var_expt[max_diversty_all,]$ss_res[[1]],
                             xlims = c(-7, -1))
p_overlay1
```

```{r}
p_overlay2 <- plot_ss_result2(var_expt[no_diversity,]$ss_res[[1]],
                             var_expt[max_only_CB_diversity,]$ss_res[[1]],
                             xlims = c(-7, -1))
p_overlay2

#ss_result1 <- var_expt[no_diversity,]$ss_res[[1]]
#ss_result2 <- var_expt[max_only_CB_diversity,]$ss_res[[1]]

```

```{r}
p_overlay3 <- plot_ss_result2(var_expt[no_diversity,]$ss_res[[1]],
                             var_expt[max_only_SBPB_diversity,]$ss_res[[1]],
                             xlims = c(-7, -1))
p_overlay3


#ss_result3 <- var_expt[max_only_SBPB_diversity,]$ss_res[[1]]


```






## I (Owen) do not recall why we made the graphs in this section

```{r}
tempp1 <- var_expt[no_diversity,]$ss_res[[1]] %>%
  filter(initial_N_CB == 1e10,
         log10(a_O) > -4.5, log10(a_O) < -4)
tempp2 <- var_expt[max_only_SBPB_diversity,]$ss_res[[1]] %>%
  filter(initial_N_CB == 1e10,
         log10(a_O) > -4.5, log10(a_O) < -4)

ggplot() +
  geom_line(mapping = aes(x = log10(tempp1$a_O),
                          y = log10(tempp1$O))) +
  geom_line(mapping = aes(x = log10(tempp2$a_O),
                          y = log10(tempp2$O)),
            col = "blue")

ggplot() +
  geom_histogram(mapping = aes(x = log10(tempp1$O) - log10(tempp2$O)),
            col = "blue")

ggplot() +
  geom_line(mapping = aes(x = log10(tempp1$a_O),
    y = log10(tempp1$P) - log10(tempp2$P)),
            col = "blue")

```

### Raw Stability

```{r}
CB_vars <- unique(stab_data$CB_var_gmax_s)
SB_vars <- unique(stab_data$SB_var_gmax_s)

CB_stab_data <- stab_data %>%
  filter(SB_var_gmax_s == 0) %>%
  mutate(var_treat = "CB",
         var_gmax = CB_var_gmax_s)

SBPB_stab_data <- stab_data %>%
  filter(CB_var_gmax_s == 0) %>%
  mutate(var_treat = "SB-PB",
         var_gmax = SB_var_gmax_s)

for_join <- tibble(CB_var_gmax_s = CB_vars,
                     SB_var_gmax_s = SB_vars)
CBSBPB_stab_data <- stab_data %>%
  right_join(for_join) %>%
  mutate(var_treat = "CB-SB-PB",
         var_gmax = CB_var_gmax_s)

all_stab_results <- CB_stab_data %>%
  bind_rows(SBPB_stab_data) %>%
#  bind_rows(results3) %>%
 # bind_rows(results4) %>%
  bind_rows(CBSBPB_stab_data)

all_stab_results<- all_stab_results %>%
    mutate(var_treat = forcats::fct_relevel(var_treat, levels = c("CB", "SB-PB", "CB-SB-PB")))

#saveRDS(all_stab_results, here("experiments/experiment summary/all_stab.RDS"))


#all_stab_results <- readRDS(here("experiments/experiment summary/all_stab.RDS"))

```


```{r}
all_stab_results %>%
  filter(Species == "O") %>%
  ggplot(aes(x = var_gmax, y = hyst_range_raw, col=var_treat, shape = as_factor(sim_length))) +
  geom_point() +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Extent of bistability region\n[oxygen diffusivity]") +
  labs(col = "Variation in\nonly these\nfunctional groups")
##ggsave("manuscript/figures/extent_of_bistab1.pdf", height = 4)

all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = var_gmax,
             ymin = hyst_min_raw,
             ymax = hyst_max_raw,
             fill=var_treat)) +
  geom_ribbon(alpha = 0.5) +
  facet_wrap( ~ var_treat, nrow = 3) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") + 
  coord_flip() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )

##ggsave("manuscript/figures/extent_of_bistab2.pdf", height = 4)
stab_data %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = CB_var_gmax_s, y = SB_var_gmax_s, fill = hyst_range_raw, col = hyst_range_raw)) +
  geom_point(size = 3)

##ggsave("manuscript/figures/extent_of_bistab2.pdf", height = 4)

stab_data %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = CB_var_gmax_s, y = hyst_range_raw, col = as.factor(SB_var_gmax_s))) +
  geom_line(size = 2)
```

### Log Stability
```{r}
all_stab_results %>%
  filter(Species == "O") %>%
  ggplot(aes(x = var_gmax, y = hyst_range_log, col=var_treat, shape = as_factor(sim_length))) +
  geom_point() +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Extent of bistability region\n[log10 oxygen diffusivity]") +
  labs(col = "Variation in\nonly these\nfunctional groups")
##ggsave("manuscript/figures/extent_of_bistab1.pdf", height = 4)

all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = var_gmax,
             ymin = hyst_min_log,
             ymax = hyst_max_log,
             fill=var_treat)) +
  geom_ribbon(alpha = 0.5) +
  facet_wrap( ~ var_treat, nrow = 3) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[log10 uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") + 
  coord_flip() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )

##ggsave("manuscript/figures/extent_of_bistab2.pdf", height = 4)
stab_data %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = CB_var_gmax_s, y = SB_var_gmax_s, fill = hyst_range_log, col = hyst_range_log)) +
  geom_point(size = 3)

##ggsave("manuscript/figures/extent_of_bistab2.pdf", height = 4)

stab_data %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = CB_var_gmax_s, y = hyst_range_log, col = as.factor(SB_var_gmax_s))) +
  geom_line(size = 2)
```

## What effect of changing the length of the simulations

```{r}
var_expt1 <- readRDS(here("experiments/experiment 1/data/ss_data_1000000_20factorial.RDS"))
var_expt2 <- readRDS(here("experiments/experiment 1/data/ss_data_80000.RDS"))

p1_short  <- plot_ss_result1(var_expt2,
                result_index = max_diversty_all,
                filename_prefix = NULL,
                save_image_file = FALSE)
p1_short

p1_long  <- plot_ss_result1(var_expt1,
                result_index = max_diversty_all,
                filename_prefix = NULL,
                save_image_file = FALSE)
p1_long


```



# Some puzzles

## Puzzle 1

When the environment ameliorates for the sulphur bacteria, there is no strain replacement (in final state) along the oxygen diffusivity gradient -- either the system is oxic or the least tolerant strain SB9 dominates. And yet the switch to anoxic occurs earlier than when there is no diversity, which suggests there is some role of the more tolerant strains. Indeed Uriah showed that the presence of only the most tolerant strain is sufficient to give an earlier switch, even though it is not present in the final state when less tolerant strains are present. And he showed that the presence of only the least tolerant strain creates a later switch than when there are more tolerant strains.

The explanation is that the most tolerant strain does play a role, but only a transient one. The following dynamics are for the system starting oxic, and with a value of oxygen diffusivity (log10(a_O) = -4.8) for which the system remains oxic if there is no diversity, but switches to anoxic if there is diversity. There is only diversity in the sulphur bacteria. The most tolerant strain does at first grow, but is then outcompeted by less tolerant strains as the environment ameliorates (temporally).


```{r}
var_expt <- readRDS(here("experiments/experiment 1/data/ss_data_1e6_x2x6_factorial.RDS"))
var_expt_levels <- var_expt[,1:6]
no_diversity <- which(rowSums(abs(var_expt_levels))==0)
max_diversty_all <- which(max(rowSums(abs(var_expt_levels))) ==
                            rowSums(abs(var_expt_levels)))
max_only_CB_diversity <- which(max(rowSums(abs(var_expt_levels[,1:2]))) ==
                            rowSums(abs(var_expt_levels[,1:2])) &
                              rowSums(abs(var_expt_levels[,3:6]))==0)
max_only_SBPB_diversity <- which(max(rowSums(abs(var_expt_levels[,3:6]))) ==
                            rowSums(abs(var_expt_levels[,3:6])) &
                              rowSums(abs(var_expt_levels[,1:2]))==0)
```

```{r eval = eval_dynamics_flag}
default_sim_duration <- 100000
```

```{r eval = eval_dynamics_flag}
default_log10a_series <- c(-4.8, -4.8)
initial_state <- new_initial_state(num_CB_strains,
                                   num_PB_strains,
                                   num_SB_strains,
                                   values = "bush_ssfig3")
initial_state[grep("CB_", names(initial_state))] <- 10^10/num_CB_strains
sim_res_novar1 <- run_simulation(parameter_values = var_expt$pars[[no_diversity]],
                          initial_state = initial_state)
saveRDS(sim_res_novar1, here("experiments/experiment 1/data/puzzle1_1.RDS"))
```


```{r}
sim_res_novar1 <- readRDS(here("experiments/experiment 1/data/puzzle1_1.RDS"))
plot_dynamics(sim_res_novar1)
#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)
```


```{r eval = eval_dynamics_flag}
sim_res_novar1 <- run_simulation(parameter_values = var_expt$pars[[max_only_SBPB_diversity]],
                          initial_state = initial_state)
saveRDS(sim_res_novar1, here("experiments/experiment 1/data/puzzle1_2.RDS"))
```

```{r}
sim_res_novar1 <- readRDS(here("experiments/experiment 1/data/puzzle1_2.RDS"))
plot_dynamics(sim_res_novar1)
#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)
```







# Zoom in on SS

```{r eval = FALSE}
a_Os <- 10^seq(-2.479, -2.4785, length=grid_num_a) ## sequence of a_0 values
initial_CBs <- 1#10^seq(0, 0, length=grid_num_N) ## sequence of N values
initial_PBs <- 1e8 ## not varied
initial_SBs <- 1e8 ## not varied
# next line creates all possible combinations
ss_expt <- expand.grid(N_CB = initial_CBs,
                      N_PB = initial_PBs,
                      N_SB = initial_SBs,
                      a_O = a_Os)
var_expt_master <- var_expt
var_expt <- var_expt_master[381,]
```


```{r}
#var_expt <- run_ss_var_experiment()
#saveRDS(var_expt, here("experiments/experiment 1/data/ss_data_zoom.RDS"))
```


```{r}
library(here)
zoom <- readRDS(here("experiments/experiment 1/data/ss_data_zoom.RDS"))

p1  <- plot_ss_result1(zoom,
                result_index = 1,
                filename_prefix = NULL,
                save_image_file = FALSE)
p1
```








# Negative abundance investigation

I (Owen) found that the sampling interval had an effect on the stability of the simulation. If the sampling interval was long, then in some rare cases (see below) the odesolver failed, with negative abundances occuring. I think this is due to abundances becoming very small, and then the computer having trouble with precision. I guess that when a sample is taken, the abundance is somehow altered if it is very low, probably by some rounding.

```{r eval = FALSE}
var_expt$pars[[1]]
dd <- var_expt$ss_res[[1]]
dd1 <- filter(dd, PB_1<(-0.0001))
dd1$a_O

ss_expt_master <- ss_expt
ss_expt <- ss_expt_master[abs(ss_expt_master$a_O - 1.336984e-05)<1e-10,]

var_expt_master <- var_expt
#var_expt <- var_expt[1,]
var_expt_test <- run_ss_var_experiment()
res <- var_expt_test$ss_res[[1]]

test1 <- ss_by_a_N(ss_expt, var_expt$pars[[1]])
x <- ss_expt[2,]
param <- var_expt$pars[[1]]
get_final_states_a_N(x, param)
ssfind_parameters <- param
ssfind_simulation_sampling_interval <- 1000
## now run inside the function "get_final_states_a_N"
simres1 <- simres
ssfind_simulation_sampling_interval <- 5000
## now run inside the function "get_final_states_a_N"
simres2 <- simres  # this fails

## now run inside the function "get_final_states_a_N"
plot_dynamics(simres2)

ggplot() +
  geom_line(data = simres1$result,
             mapping = aes(x = time, y = log10(PB_1))) +
  geom_point(data = simres2$result,
             mapping = aes(x = time, y = log10(PB_1))) +
  xlim(c(0, 250000))

ccc <- simres2$result

simres2$result$PB_1
simres2$result$time


log10_a <- log10(ss_expt$a_O[1]) ## very slowly goes anoxic
#log10_a <- log10(a_Os[354]) ## very slowly goes anoxic
#log10_a <- log10(a_Os[356]) ## very very very  slowly goes anoxic
#log10_a <- log10(a_Os[357]) ## does not go anoxic



default_dynamic_model <- bushplus_dynamic_model
default_event_definition <- event_definition_1
default_event_interval <- ssfind_simulation_duration
default_noise_sigma <- 0
default_minimum_abundances <- ssfind_minimum_abundances
default_sim_duration <- ssfind_simulation_duration
default_sim_sample_interval <- ssfind_simulation_duration
#initial_pars_from <- "bush_ssfig3"


default_log10a_series <- c(log10_a, log10_a)
initial_state <- new_initial_state(num_CB_strains,
                                   num_PB_strains,
                                   num_SB_strains,
                                   values = "bush_ssfig3")
initial_state[grep("CB_", names(initial_state))] <- 10^10/num_CB_strains
sim_res_novar <- run_simulation(parameter_values = var_expt$pars[[1]],
                          initial_state = initial_state)
plot_dynamics(sim_res_novar)

simulation_result <- sim_res_novar
every_n <- 1

chk <- sim_res_novar$result

sim_res_novar$result %>%
  ggplot() +
  geom_line(mapping = aes(x = time, y = PB_1))

#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)



```


# Understand about relative and absolute variation in traits

```{r echo = FALSE}
num_CB_strains <- 9
num_SB_strains <- 9
num_PB_strains <- 9

## multiplier of SBPB variation
CB_var_multiplier <- 1
SBPB_var_multiplier <- 5

CB_gmax_div <- 0.015789474 * CB_var_multiplier
CB_h_div <- -0.08 * CB_var_multiplier
SB_gmax_div <- 0.015789474 * SBPB_var_multiplier
SB_h_div <- -0.323  * SBPB_var_multiplier
PB_gmax_div <- 0.015789474  * SBPB_var_multiplier
PB_h_div <- -0.323  * SBPB_var_multiplier

num_div_treatment_levels <- 2

var_expt <- create_diversity_factorial()

display_diversity(4)

this_one <- 4
CBtraits <- var_expt$pars[[this_one]]$CB
P <- 1 #10^seq(-5, 5, 0.1)
SR <- 10^seq(0, 3, 0.1)
gr_rateCB1 <- growth1(P, CBtraits$g_max_CB[1], CBtraits$k_CB_P[1]) * inhibition(SR, CBtraits$h_SR_CB[1])
gr_rateCB9 <- growth1(P, CBtraits$g_max_CB[num_CB_strains], CBtraits$k_CB_P[num_CB_strains]) * inhibition(SR, CBtraits$h_SR_CB[num_CB_strains])
CB_gr_rates <- (c(gr_rateCB1, gr_rateCB9))
CB_gr_range <- max(CB_gr_rates) - min(CB_gr_rates)
CB_gr_range

SBtraits <- var_expt$pars[[this_one]]$SB
P <- 1 #10^seq(-5, 5, 0.1)
SO <- 1
O <- 10^seq(-2.5, 2.5, 0.1)
gr_rateSB1 <- growth2(P, SO, SBtraits$g_max_SB[1], SBtraits$k_SB_P[1], SBtraits$k_SB_SO[1]) *
  inhibition(O, SBtraits$h_O_SB[1])
gr_rateSB9 <- growth2(P, SO, SBtraits$g_max_SB[9], SBtraits$k_SB_P[9], SBtraits$k_SB_SO[9]) *
    inhibition(O, SBtraits$h_O_SB[9])
SB_gr_rates <- (c(gr_rateSB1, gr_rateSB9))
SB_gr_range <- max(SB_gr_rates) - min(SB_gr_rates)
SB_gr_range

PBtraits <- var_expt$pars[[this_one]]$PB
P <- 1 #10^seq(-5, 5, 0.1)
SO <- 1
O <- 10^seq(-2.5, 2.5, 0.1)
gr_ratePB1 <- growth2(P, SO, PBtraits$g_max_PB[1], PBtraits$k_PB_P[1], PBtraits$k_PB_SR[1]) *
  inhibition(O, PBtraits$h_O_PB[1])
gr_ratePB9 <- growth2(P, SO, PBtraits$g_max_PB[9], PBtraits$k_PB_P[9], PBtraits$k_PB_SR[9]) *
  inhibition(O, PBtraits$h_O_PB[9])
PB_gr_rates <- (c(gr_ratePB1, gr_ratePB9))
PB_gr_range <- max(PB_gr_rates) - min(PB_gr_rates)
PB_gr_range

```

With the CB diversity multiplier set at `r CB_var_multiplier` and the SB/PB multiplier set at `r SBPB_var_multiplier` the range of realised growth rates of CB is `r CB_gr_range`, range of SB is `r SB_gr_range`, and range of PB is `r PB_gr_range`.












