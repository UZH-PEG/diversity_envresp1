---
title: "6 strains"
author: "Owen Petchey"
date: "6/25/2021"
output:
  pdf_document: default
  html_document:
    keep_md: yes
---

This experiment supersedes all previous ones.
It is a factorial manipulation of diversity of the three groups.
It takes about 50 hours to run while using 12 cores.


# Setup

## R

```{r setup}


# rm(list = ls())

knitr::opts_knit$set(
  progress = TRUE, 
  verbose = FALSE, 
  cache = TRUE
)

microxanox_release <- "0.3.0"

#tmplib <- tempfile()
#dir.create(tmplib)


### From '?remotes::install_github`:
# auth_token
#   To install from a private repo, generate a personal access token (PAT) in
#   "https://github.com/settings/tokens" and supply to this argument. This is
#   safer than using a password because you can easily delete a PAT without
#   affecting any others. Defaults to the GITHUB_PAT environment variable.

# remotes::install_github(
#   "opetchey/microxanox",
#   ref = microxanox_release,
#   # auth_token = "ENTER YOUR TOKEN or PROVED AS ENVIRONMENT VARIABLE",
#   build_vignettes = FALSE,
#   force = TRUE,
#   upgrade = FALSE,
#   lib = tmplib
# )

#library(microxanox, lib.loc = tmplib)

library(microxanox)
if (packageVersion("microxanox") < package_version("0.3.0")) {
  stop("microxanox version needs to be at least 0.3.0!")
}
library(tidyverse)
library(patchwork)
library(here)
source(here("R/various_useful_functions.r"))
zero <- 0 ## don't change
unity <- 1 ## don't change!!!
options(mc.cores = 7)
eval_dynamics_flag <- FALSE
plot_ss_results <- FALSE
```

## Version of `microxanox` package used: `r packageVersion("microxanox") `

## General simulation conditions

```{r}

num_CB_strains <- 6
num_SB_strains <- 6
num_PB_strains <- 6

sp <- new_strain_parameter(
  n_CB = num_CB_strains,
  n_PB = num_SB_strains,
  n_SB = num_PB_strains,
  values_initial_state = "bush_ssfig3"
)

parameter <- new_runsim_parameter(
  dynamic_model = bushplus_dynamic_model,
  event_definition = event_definition_1,
  event_interval = 100,
  noise_sigma = 0,
  minimum_abundances = rep(1, 3),
  sim_duration = 2000,
  sim_sample_interval = 100,
  strain_parameter = sp,
  log10a_series = c(
    log10(sp$a_O),
    log10(sp$a_O)
  )
)
names(parameter$minimum_abundances) <- c("CB", "PB", "SB")
rm(sp)

```


## Define diversity

```{r}
## multiplier of SBPB variation
CB_var_multiplier <- 2
SBPB_var_multiplier <- 6

CB_gmax_div <- 0.015789474 * CB_var_multiplier
CB_h_div <- -0.08 * CB_var_multiplier
SB_gmax_div <- 0.015789474 * SBPB_var_multiplier
SB_h_div <- -0.323  * SBPB_var_multiplier
PB_gmax_div <- 0.015789474  * SBPB_var_multiplier
PB_h_div <- -0.323  * SBPB_var_multiplier

num_div_treatment_levels <- 20

```

## Create diversity

```{r}
var_expt <- create_diversity_factorial(
  zero = zero, unity = unity,
  num_div_treatment_levels = num_div_treatment_levels,
  CB_gmax_div = CB_gmax_div, CB_h_div = CB_h_div,
  SB_gmax_div = SB_gmax_div, SB_h_div = SB_h_div,
  PB_gmax_div = PB_gmax_div, PB_h_div = PB_h_div,
  default_9strain = new_strain_parameter(
    n_CB = num_CB_strains,
    n_SB = num_SB_strains,
    n_PB = num_PB_strains,
    values_initial_state =  "bush_ssfig3"
  )
)
```

## Display diversity

```{r}
display_diversity(
  400,
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains
)
```


# Temporal switching


```{r}
## Here we get some rows of var_expt that correspond with particular diversity levels

var_expt_levels <- var_expt[, 1:6]

no_diversity <- which(rowSums(abs(var_expt_levels)) == 0)
max_diversty_all <- which(
  max(rowSums(abs(var_expt_levels))) == rowSums(abs(var_expt_levels))
)
max_only_CB_diversity <- which(
  max(rowSums(abs(var_expt_levels[, 1:2]))) == rowSums(abs(var_expt_levels[, 1:2])) &
  rowSums(abs(var_expt_levels[,3:6])) == 0
)
# var_expt_levels[381,]

max_only_SBPB_diversity <- which(
  max(rowSums(abs(var_expt_levels[, 3:6]))) == rowSums(abs(var_expt_levels[, 3:6])) &
  rowSums(abs(var_expt_levels[, 1:2])) == 0
)
#var_expt_levels[20,]

medium_diverity_varexp_row <- 311

```




## Oxic to anoxic

### No diversity

```{r eval = eval_dynamics_flag}
parameter$sim_duration <- 80000
```

```{r eval = eval_dynamics_flag}
parameter$log10a_series <- c(-1, -7, -7)
parameter$strain_parameter <- var_expt$pars[[no_diversity]]
parameter$strain_parameter$initial_state <- new_initial_state(
  num_CB_strains,
  num_PB_strains,
  num_SB_strains,
  values = "bush_ssfig3"
)
parameter$strain_parameter$initial_state[grep("CB_", names(parameter$strain_parameter$initial_state))] <- 10^10/num_CB_strains
sim_res_novar1 <- run_simulation(parameter)
saveRDS(sim_res_novar1, here("experiments/6_strains/data/sim_res_novar1.RDS"))
```


```{r}
sim_res_novar1 <- readRDS(here("experiments/6_strains/data/sim_res_novar1.RDS"))
plot_dynamics(sim_res_novar1)
#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)
```

### With diversity

```{r eval = eval_dynamics_flag}
parameter$strain_parameter <- var_expt$pars[[medium_diverity_varexp_row]]
parameter$strain_parameter$initial_state <- sim_res_novar1$strain_parameter$initial_state
sim_res_highvar1 <- run_simulation(parameter)
saveRDS(sim_res_highvar1, here("experiments/6_strains/data/sim_res_highvar1.RDS"))
```


```{r}
sim_res_highvar1 <- readRDS(here("experiments/6_strains/data/sim_res_highvar1.RDS"))
plot_dynamics(sim_res_highvar1)
#ggsave(here("simulationsexpt2/figures/switching_highvar.pdf"), width = 10)

```

## Anoxic to oxic

### No diversity

```{r eval = eval_dynamics_flag}
parameter$sim_duration <- 60000
```


```{r eval = eval_dynamics_flag}
parameter$log10a_series <- c(-5, -3, -1, -1)
parameter$strain_parameter <- var_expt$pars[[no_diversity]]
parameter$strain_parameter$initial_state <- new_initial_state(
  num_CB_strains,
  num_PB_strains,
  num_SB_strains,
  values = "bush_ssfig3"
)
parameter$strain_parameter$initial_state[grep("CB_", names(parameter$strain_parameter$initial_state))] <- 10/num_CB_strains
sim_res_novar2 <- run_simulation(parameter)
saveRDS(sim_res_novar2, here("experiments/6_strains/data/sim_res_novar2.RDS"))
```


```{r}
sim_res_novar2 <- readRDS(here("experiments/6_strains/data/sim_res_novar2.RDS"))
plot_dynamics(sim_res_novar2)
#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)
```

### With diversity

```{r eval = eval_dynamics_flag}
parameter$strain_parameter <- var_expt$pars[[medium_diverity_varexp_row]]
parameter$strain_parameter$initial_state <- sim_res_novar2$strain_parameter$initial_state
sim_res_highvar2 <- run_simulation(parameter)
saveRDS(sim_res_highvar2, here("experiments/6_strains/data/sim_res_highvar2.RDS"))
```


```{r}
sim_res_highvar2 <- readRDS(here("experiments/6_strains/data/sim_res_highvar2.RDS"))
plot_dynamics(sim_res_highvar2)
#ggsave(here("simulationsexpt2/figures/switching_highvar.pdf"), width = 10)

```


## Anoxic to oxic to anoxic

### No diversity

```{r eval = eval_dynamics_flag}
parameter$sim_duration <- 1000000
```

```{r eval = eval_dynamics_flag}
parameter$minimum_abundances <- rep(100, 3)
names(parameter$minimum_abundances) <- c("CB", "PB", "SB")
```

```{r eval = eval_dynamics_flag}
parameter$log10a_series <- c(-1, -8, -1)
parameter$strain_parameter <- var_expt$pars[[no_diversity]]
parameter$strain_parameter$initial_state <- new_initial_state(
  num_CB_strains,
  num_PB_strains,
  num_SB_strains,
  values = "bush_ssfig3"
)
parameter$strain_parameter$initial_state[grep("CB_", names(parameter$strain_parameter$initial_state))] <- 10/num_CB_strains
sim_res_novar3 <- run_simulation(parameter)
saveRDS(sim_res_novar3, here("experiments/6_strains/data/sim_res_novar3.RDS"))
```


```{r}
sim_res_novar3 <- readRDS(here("experiments/6_strains/data/sim_res_novar3.RDS"))
plot_dynamics(sim_res_novar3)
#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)
```

### With diversity

```{r eval = eval_dynamics_flag}
parameter$strain_parameter <- var_expt$pars[[medium_diverity_varexp_row]]
parameter$strain_parameter$initial_state <- sim_res_novar3$strain_parameter$initial_state
sim_res_highvar3 <- run_simulation(parameter)
saveRDS(sim_res_highvar3, here("experiments/6_strains/data/sim_res_highvar3.RDS"))
```


```{r}
sim_res_highvar3 <- readRDS(here("experiments/6_strains/data/sim_res_highvar3.RDS"))
plot_dynamics(sim_res_highvar3)
#ggsave(here("simulationsexpt2/figures/switching_highvar.pdf"), width = 10)

```

### Ecosystem-environment relationship

```{r eval = FALSE, echo = FALSE}
visualise_temporal_env_eco(sim_res_novar3, sim_res_highvar3)
```



# Stable state finding

## Finding

### Setup parameter

```{r}
options(mc.cores = 7)
```


```{r}
minimum_abundances <- rep(0, 3)
names(minimum_abundances) <- c("CB", "PB", "SB")

grid_num_a <- 1000 #usually 1000 ## number of a_0 values
#grid_num_a <- 10 ## FOR TEST
a_Os <- 10^seq(-7, -0.5, length=grid_num_a) ## sequence of a_0 values
grid_num_N <- 2 ## number of N values
initial_CBs <- 10^seq(0, 10, length=grid_num_N) ## sequence of N values
initial_PBs <- 1e8 ## not varied
initial_SBs <- 1e8 ## not varied
# next line creates all possible combinations
ss_expt <- expand.grid(N_CB = initial_CBs,
                      N_PB = initial_PBs,
                      N_SB = initial_SBs,
                      a_O = a_Os)

parameter <- new_ss_by_a_N_parameter(
  dynamic_model = parameter$dynamic_model,
  event_definition = parameter$event_definition,
  event_interval = 1000000,
  noise_sigma = parameter$noise_sigma,
  minimum_abundances = minimum_abundances,
  sim_duration = 1000000,
  sim_sample_interval = 1000000,
  log10a_series = parameter$log10a_series,
  solver_method = parameter$solver_method,
  ss_expt = ss_expt
)
rm(minimum_abundances, grid_num_a, a_Os, grid_num_N, initial_CBs, initial_PBs, initial_SBs, ss_expt)

saveRDS(parameter, here("experiments/6_strains/data/parameter_1e6_x2x6_factorial.RDS"))
saveRDS(var_expt, here("experiments/6_strains/data/var_expt_1e6_x2x6_factorial.RDS"))
```


### Run stable state finding

*Careful, this simulation takes about 600 hours on a single core

```{r run_experiment, eval = eval_dynamics_flag}
run_ss_var_experiment(
  parameter = readRDS(here("experiments/6_strains/data/parameter_1e6_x2x6_factorial.RDS")), 
  var_expt = readRDS(here("experiments/6_strains/data/var_expt_1e6_x2x6_factorial.RDS"))) %>%
saveRDS(here("experiments/6_strains/data/ss_data_1e6_x2x6_factorial.RDS"))
```

### Process the stable state data

Bring in various stable state datasets
```{r eval = eval_dynamics_flag}
cluster <- multidplyr::new_cluster(7)
multidplyr::cluster_library(cluster, c("microxanox", "dplyr"))

## sim length 1'000'000, 20 SBPBgrad, 2xCB variation, 6xSBPB variation
readRDS(here("experiments/6_strains/data/ss_data_1e6_x2x6_factorial_small.RDS")) %>%
  mutate(sim_length = 1000000) %>% 
  multidplyr::partition(cluster) %>%
  mutate(stability_measures = list(get_stability_measures(ss_res))) %>%
  collect() %>%
  unnest(cols = c(stability_measures)) %>%
  saveRDS(here("experiments/6_strains/data/stab_data_1e6_x2x6_factorial_small.RDS"))
```




```{r}
## find various combinations of diversity
var_expt <- readRDS(here("experiments/6_strains/data/ss_data_1e6_x2x6_factorial.RDS"))
stab_data <- readRDS(here("experiments/6_strains/data/stab_data_1e6_x2x6_factorial.RDS"))

var_expt_levels <- var_expt[,1:6]

no_diversity <- which(rowSums(abs(var_expt_levels))==0)
max_diversty_all <- which(max(rowSums(abs(var_expt_levels))) ==
                            rowSums(abs(var_expt_levels)))
max_only_CB_diversity <- which(max(rowSums(abs(var_expt_levels[,1:2]))) ==
                            rowSums(abs(var_expt_levels[,1:2])) &
                              rowSums(abs(var_expt_levels[,3:6]))==0)
#var_expt_levels[381,]

max_only_SBPB_diversity <- which(max(rowSums(abs(var_expt_levels[,3:6]))) ==
                            rowSums(abs(var_expt_levels[,3:6])) &
                              rowSums(abs(var_expt_levels[,1:2]))==0)
#var_expt_levels[20,]

medium_diverity_varexp_row <- 311

```

### Display results


```{r eval = plot_ss_results}

p1  <- plot_ss_result1(var_expt,
                result_index = no_diversity,
                filename_prefix = NULL,
                save_image_file = FALSE)
p1




p2  <- plot_ss_result1(var_expt,
                result_index = max_diversty_all,
                filename_prefix = NULL,
                save_image_file = FALSE)
p2



p3  <- plot_ss_result1(var_expt,
                result_index = max_only_CB_diversity,
                filename_prefix = NULL,
                save_image_file = FALSE)
p3


p4  <- plot_ss_result1(var_expt,
                result_index = max_only_SBPB_diversity,
                filename_prefix = NULL,
                save_image_file = FALSE)
p4


p_overlay1 <- plot_ss_result2(var_expt[no_diversity,]$ss_res[[1]],
                             var_expt[max_diversty_all,]$ss_res[[1]],
                             xlims = c(-7, -1))
p_overlay1


p_overlay2 <- plot_ss_result2(var_expt[no_diversity,]$ss_res[[1]],
                             var_expt[max_only_CB_diversity,]$ss_res[[1]],
                             xlims = c(-7, -1))
p_overlay2


p_overlay3 <- plot_ss_result2(var_expt[no_diversity,]$ss_res[[1]],
                             var_expt[max_only_SBPB_diversity,]$ss_res[[1]],
                             xlims = c(-7, -1))
p_overlay3



```


```{r eval = plot_ss_results}
tempp1 <- var_expt[no_diversity,]$ss_res[[1]] %>%
  filter(initial_N_CB == 1e10,
         log10(a_O) > -4.5, log10(a_O) < -4)
tempp2 <- var_expt[max_only_SBPB_diversity,]$ss_res[[1]] %>%
  filter(initial_N_CB == 1e10,
         log10(a_O) > -4.5, log10(a_O) < -4)

ggplot() +
  geom_line(mapping = aes(x = log10(tempp1$a_O),
                          y = log10(tempp1$O))) +
  geom_line(mapping = aes(x = log10(tempp2$a_O),
                          y = log10(tempp2$O)),
            col = "blue")

ggplot() +
  geom_histogram(mapping = aes(x = log10(tempp1$O) - log10(tempp2$O)),
            col = "blue")

ggplot() +
  geom_line(mapping = aes(x = log10(tempp1$a_O),
    y = log10(tempp1$P) - log10(tempp2$P)),
            col = "blue")

```



```{r eval = plot_ss_results}
CB_vars <- unique(stab_data$CB_var_gmax_s)
SB_vars <- unique(stab_data$SB_var_gmax_s)

CB_stab_data <- stab_data %>%
  filter(SB_var_gmax_s == 0) %>%
  mutate(var_treat = "CB",
         var_gmax = CB_var_gmax_s)

SBPB_stab_data <- stab_data %>%
  filter(CB_var_gmax_s == 0) %>%
  mutate(var_treat = "SB-PB",
         var_gmax = SB_var_gmax_s)

for_join <- tibble(CB_var_gmax_s = CB_vars,
                     SB_var_gmax_s = SB_vars)
CBSBPB_stab_data <- stab_data %>%
  right_join(for_join) %>%
  mutate(var_treat = "CB-SB-PB",
         var_gmax = CB_var_gmax_s)

all_stab_results <- CB_stab_data %>%
  bind_rows(SBPB_stab_data) %>%
#  bind_rows(results3) %>%
 # bind_rows(results4) %>%
  bind_rows(CBSBPB_stab_data)

all_stab_results <- all_stab_results %>%
    mutate(var_treat = forcats::fct_relevel(var_treat, levels = c("CB", "SB-PB", "CB-SB-PB")))

#saveRDS(all_stab_results, here("experiments/experiment summary/all_stab.RDS"))


#all_stab_results <- readRDS(here("experiments/experiment summary/all_stab.RDS"))
```

### Raw
```{r eval = plot_ss_results}
all_stab_results %>%
  filter(Species == "O") %>%
  ggplot(aes(x = var_gmax, y = hyst_range_raw, col=var_treat, shape = as_factor(sim_length))) +
  geom_point() +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Extent of bistability region\n[log10 oxygen diffusivity]") +
  labs(col = "Variation in\nonly these\nfunctional groups")
##ggsave("manuscript/figures/extent_of_bistab1.pdf", height = 4)

all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = var_gmax,
             ymin = hyst_min_raw,
             ymax = hyst_max_raw,
             fill=var_treat)) +
  geom_ribbon(alpha = 0.5) +
  facet_wrap( ~ var_treat, nrow = 3) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[log10 uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") +
  coord_flip() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )

##ggsave("manuscript/figures/extent_of_bistab2.pdf", height = 4)
stab_data %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = CB_var_gmax_s, y = SB_var_gmax_s, fill = hyst_range_raw, col = hyst_range_raw)) +
  geom_point(size = 3)


##ggsave("manuscript/figures/extent_of_bistab2.pdf", height = 4)

stab_data %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = CB_var_gmax_s, y = hyst_range_raw, col = as.factor(SB_var_gmax_s))) +
  geom_line(size = 2)
```

### Log transformed

```{r eval = plot_ss_results}
all_stab_results %>%
  filter(Species == "O") %>%
  ggplot(aes(x = var_gmax, y = hyst_range_log, col=var_treat, shape = as_factor(sim_length))) +
  geom_point() +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Extent of bistability region\n[log10 oxygen diffusivity]") +
  labs(col = "Variation in\nonly these\nfunctional groups")
##ggsave("manuscript/figures/extent_of_bistab1.pdf", height = 4)

all_stab_results %>%
  #filter(var_treat == "CB") %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = var_gmax,
             ymin = hyst_min_log,
             ymax = hyst_max_log,
             fill=var_treat)) +
  geom_ribbon(alpha = 0.5) +
  facet_wrap( ~ var_treat, nrow = 3) +
  xlab("Amount of trait variation\n[see text for units]") +
  ylab("Oxygen diffusivity\n[log10 uM per hour]") +
  labs(fill = "Variation in\nonly these\nfunctional groups") +
  coord_flip() +
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )

##ggsave("manuscript/figures/extent_of_bistab2.pdf", height = 4)
stab_data %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = CB_var_gmax_s, y = SB_var_gmax_s, fill = hyst_range_log, col = hyst_range_log)) +
  geom_point(size = 3)


##ggsave("manuscript/figures/extent_of_bistab2.pdf", height = 4)

stab_data %>%
  filter(Species == "O",
         sim_length == 1e6) %>%
  ggplot(aes(x = CB_var_gmax_s, y = hyst_range_log, col = as.factor(SB_var_gmax_s))) +
  geom_line(size = 2)
```

