---
title: "find discont"
author: "Owen Petchey"
date: "11/15/2021"
output: html_document
---
---
title: "3 strains"
author: "Owen Petchey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document:
    keep_md: yes
---

This experiment supersedes all previous ones.
It is a factorial manipulation of diversity of the three groups.
It takes about 50 hours to run while using 12 cores.


# Setup

## R

```{r setup}


# rm(list = ls())

knitr::opts_knit$set(
  progress = TRUE, 
  verbose = FALSE, 
  cache = TRUE
)

microxanox_release <- "0.3.0"

#tmplib <- tempfile()
#dir.create(tmplib)


### From '?remotes::install_github`:
# auth_token
#   To install from a private repo, generate a personal access token (PAT) in
#   "https://github.com/settings/tokens" and supply to this argument. This is
#   safer than using a password because you can easily delete a PAT without
#   affecting any others. Defaults to the GITHUB_PAT environment variable.

# remotes::install_github(
#   "opetchey/microxanox",
#   ref = microxanox_release,
#   # auth_token = "ENTER YOUR TOKEN or PROVED AS ENVIRONMENT VARIABLE",
#   build_vignettes = FALSE,
#   force = TRUE,
#   upgrade = FALSE,
#   lib = tmplib
# )

#library(microxanox, lib.loc = tmplib)

library(microxanox)
if (packageVersion("microxanox") < package_version("0.3.0")) {
  stop("microxanox version needs to be at least 0.3.0!")
}
library(tidyverse)
library(patchwork)
library(here)
source(here("R/various_useful_functions.r"))
zero <- 0 ## don't change
unity <- 1 ## don't change!!!
options(mc.cores = 7)
eval_dynamics_flag <- FALSE
plot_ss_results <- FALSE
```

## Version of `microxanox` package used: `r packageVersion("microxanox") `

## General simulation conditions

```{r}

num_CB_strains <- 3
num_SB_strains <- 3
num_PB_strains <- 3

sp <- new_strain_parameter(
  n_CB = num_CB_strains,
  n_PB = num_SB_strains,
  n_SB = num_PB_strains,
  values_initial_state = "bush_ssfig3"
)

parameter <- new_runsim_parameter(
  dynamic_model = bushplus_dynamic_model,
  event_definition = event_definition_1,
  event_interval = 100,
  noise_sigma = 0,
  minimum_abundances = rep(1, 3),
  sim_duration = 2000,
  sim_sample_interval = 100,
  strain_parameter = sp,
  log10a_series = c(
    log10(sp$a_O),
    log10(sp$a_O)
  )
)
names(parameter$minimum_abundances) <- c("CB", "PB", "SB")
rm(sp)

```


## Define diversity

```{r}
## multiplier of SBPB variation
CB_var_multiplier <- 2
SBPB_var_multiplier <- 6

CB_gmax_div <- 0.015789474 * CB_var_multiplier
CB_h_div <- -0.08 * CB_var_multiplier
SB_gmax_div <- 0.015789474 * SBPB_var_multiplier
SB_h_div <- -0.323  * SBPB_var_multiplier
PB_gmax_div <- 0.015789474  * SBPB_var_multiplier
PB_h_div <- -0.323  * SBPB_var_multiplier

num_div_treatment_levels <- 20

```

## Create diversity

```{r}
var_expt <- create_diversity_factorial(
  zero = zero, unity = unity,
  num_div_treatment_levels = num_div_treatment_levels,
  CB_gmax_div = CB_gmax_div, CB_h_div = CB_h_div,
  SB_gmax_div = SB_gmax_div, SB_h_div = SB_h_div,
  PB_gmax_div = PB_gmax_div, PB_h_div = PB_h_div,
  default_9strain = new_strain_parameter(
    n_CB = num_CB_strains,
    n_SB = num_SB_strains,
    n_PB = num_PB_strains,
    values_initial_state =  "bush_ssfig3"
  )
)
```


## Display diversity

```{r}
display_diversity(
  nrow(var_expt),
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains
)
```



```{r eval = eval_dynamics_flag}
parameter$sim_duration <- 8000
parameter$sim_sample_interval <- parameter$sim_duration
parameter$log10a_series <- c(-4, -4)
parameter$strain_parameter <- var_expt$pars[[no_diversity]]
parameter$strain_parameter$initial_state <- new_initial_state(
  num_CB_strains,
  num_PB_strains,
  num_SB_strains,
  values = "bush_ssfig3"
)


get_final_oxygen <- function(x) {
  parameter$strain_parameter$initial_state[grep("CB_", names(parameter$strain_parameter$initial_state))] <- 10 ^ (x) /
    num_CB_strains
  sim_res_novar1 <- run_simulation(parameter)
  temp <- sim_res_novar1$result$O
  temp[length(temp)]
}
get_final_oxygen(1)
get_final_oxygen(2)
get_final_oxygen(3)
get_final_oxygen(4)
get_final_oxygen(5)
get_final_oxygen(6)
get_final_oxygen(7)
get_final_oxygen(8)
get_final_oxygen(9)
get_final_oxygen(10)

parameter$strain_parameter$initial_state[grep("CB_", names(parameter$strain_parameter$initial_state))] <- 10^1/num_CB_strains
sim_res_novar1 <- run_simulation(parameter)
sim_res_novar1$result$O



```

