---
title: "Checks and puzzles"
author: "Owen Petchey"
date: "6/25/2021"
output:
  pdf_document: default
  html_document:
    keep_md: yes
---

# Setup

## R

```{r setup}


# rm(list = ls())

knitr::opts_knit$set(
  progress = TRUE, 
  verbose = FALSE, 
  cache = TRUE
)

microxanox_release <- "0.3.0"

#tmplib <- tempfile()
#dir.create(tmplib)


### From '?remotes::install_github`:
# auth_token
#   To install from a private repo, generate a personal access token (PAT) in
#   "https://github.com/settings/tokens" and supply to this argument. This is
#   safer than using a password because you can easily delete a PAT without
#   affecting any others. Defaults to the GITHUB_PAT environment variable.

# remotes::install_github(
#   "opetchey/microxanox",
#   ref = microxanox_release,
#   # auth_token = "ENTER YOUR TOKEN or PROVED AS ENVIRONMENT VARIABLE",
#   build_vignettes = FALSE,
#   force = TRUE,
#   upgrade = FALSE,
#   lib = tmplib
# )

#library(microxanox, lib.loc = tmplib)

library(microxanox)
if (packageVersion("microxanox") < package_version("0.3.0")) {
  stop("microxanox version needs to be at least 0.3.0!")
}
library(tidyverse)
library(patchwork)
library(here)
source(here("R/various_useful_functions.r"))
zero <- 0 ## don't change
unity <- 1 ## don't change!!!
options(mc.cores = 7)
eval_dynamics_flag <- FALSE
```

## Version of `microxanox` package used: `r packageVersion("microxanox") `

## General simulation conditions

```{r}

num_CB_strains <- 9
num_SB_strains <- 9
num_PB_strains <- 9

sp <- new_strain_parameter(
  n_CB = num_CB_strains,
  n_PB = num_SB_strains,
  n_SB = num_PB_strains,
  values_initial_state = "bush_ssfig3"
)

parameter <- new_runsim_parameter(
  dynamic_model = bushplus_dynamic_model,
  event_definition = event_definition_1,
  event_interval = 100,
  noise_sigma = 0,
  minimum_abundances = rep(1, 3),
  sim_duration = 2000,
  sim_sample_interval = 100,
  strain_parameter = sp,
  log10a_series = c(
    log10(sp$a_O),
    log10(sp$a_O)
  )
)
names(parameter$minimum_abundances) <- c("CB", "PB", "SB")
parameter_master <- parameter
rm(sp)

```


## Define diversity

```{r}
## multiplier of SBPB variation
CB_var_multiplier <- 2
SBPB_var_multiplier <- 6

CB_gmax_div <- 0.015789474 * CB_var_multiplier
CB_h_div <- -0.08 * CB_var_multiplier
SB_gmax_div <- 0.015789474 * SBPB_var_multiplier
SB_h_div <- -0.323  * SBPB_var_multiplier
PB_gmax_div <- 0.015789474  * SBPB_var_multiplier
PB_h_div <- -0.323  * SBPB_var_multiplier

num_div_treatment_levels <- 5

```

## Create diversity

```{r}
var_expt <- create_diversity_factorial(
  zero = zero, unity = unity,
  num_div_treatment_levels = num_div_treatment_levels,
  CB_gmax_div = CB_gmax_div, CB_h_div = CB_h_div,
  SB_gmax_div = SB_gmax_div, SB_h_div = SB_h_div,
  PB_gmax_div = PB_gmax_div, PB_h_div = PB_h_div,
  default_9strain = new_strain_parameter(
    n_CB = num_CB_strains,
    n_SB = num_SB_strains,
    n_PB = num_PB_strains,
    values_initial_state =  "bush_ssfig3"
  )
)
```

## Display diversity

```{r}
display_diversity(
  nrow(var_expt),
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains
)
```




```{r}
## Here we get some rows of var_expt that correspond with particular diversity levels

var_expt_levels <- var_expt[, 1:6]

no_diversity <- which(rowSums(abs(var_expt_levels)) == 0)
max_diversty_all <- which(
  max(rowSums(abs(var_expt_levels))) == rowSums(abs(var_expt_levels))
)
max_only_CB_diversity <- which(
  max(rowSums(abs(var_expt_levels[, 1:2]))) == rowSums(abs(var_expt_levels[, 1:2])) &
  rowSums(abs(var_expt_levels[,3:6])) == 0
)
# var_expt_levels[381,]

max_only_SBPB_diversity <- which(
  max(rowSums(abs(var_expt_levels[, 3:6]))) == rowSums(abs(var_expt_levels[, 3:6])) &
  rowSums(abs(var_expt_levels[, 1:2])) == 0
)
#var_expt_levels[20,]

#medium_diverity_varexp_row <- 311

```



# What effect of changing the length of the simulations

## Setup and processing

Run a shorter sim:

```{r eval = eval_dynamics_flag}

sim_length <- 100000

options(mc.cores = 7)

minimum_abundances <- rep(0, 3)
names(minimum_abundances) <- c("CB", "PB", "SB")

grid_num_a <- 1000 #usually 1000 ## number of a_0 values
#grid_num_a <- 10 ## FOR TEST
a_Os <- 10^seq(-7, -0.5, length=grid_num_a) ## sequence of a_0 values
grid_num_N <- 2 ## number of N values
initial_CBs <- 10^seq(0, 10, length=grid_num_N) ## sequence of N values
initial_PBs <- 1e8 ## not varied
initial_SBs <- 1e8 ## not varied
# next line creates all possible combinations
ss_expt <- expand.grid(N_CB = initial_CBs,
                      N_PB = initial_PBs,
                      N_SB = initial_SBs,
                      a_O = a_Os)

parameter <- new_ss_by_a_N_parameter(
  dynamic_model = parameter$dynamic_model,
  event_definition = parameter$event_definition,
  event_interval = sim_length,
  noise_sigma = parameter$noise_sigma,
  minimum_abundances = minimum_abundances,
  sim_duration = sim_length,  ##    Was 1e6
  sim_sample_interval = sim_length,
  log10a_series = parameter$log10a_series,
  solver_method = parameter$solver_method,
  ss_expt = ss_expt
)
rm(minimum_abundances, grid_num_a, a_Os, grid_num_N, initial_CBs, initial_PBs, initial_SBs, ss_expt)

saveRDS(parameter, here("experiments/checks_puzzles/data/parameter_1e5_x2x6_factorial.RDS"))
saveRDS(var_expt, here("experiments/checks_puzzles/data/var_expt_1e5_x2x6_factorial.RDS"))
```



*Careful, this simulation takes about 600 hours on a single core

```{r run_experiment, eval = eval_dynamics_flag}
run_ss_var_experiment(
  parameter = readRDS(here("experiments/checks_puzzles/data/parameter_1e5_x2x6_factorial.RDS")), 
  var_expt = readRDS(here("experiments/checks_puzzles/data/var_expt_1e5_x2x6_factorial.RDS"))) %>%
  saveRDS(here("experiments/checks_puzzles/data/ss_data_1e5_x2x6_factorial.RDS"))
```



Bring in various stable state datasets
```{r eval = eval_dynamics_flag}
cluster <- multidplyr::new_cluster(7)
multidplyr::cluster_library(cluster, c("microxanox", "dplyr"))

## sim length 1'000'000, 20 SBPBgrad, 2xCB variation, 6xSBPB variation
readRDS(here("experiments/checks_puzzles/data/ss_data_1e5_x2x6_factorial.RDS")) %>%
  mutate(sim_length = 100000) %>% 
  multidplyr::partition(cluster) %>%
  mutate(stability_measures = list(get_stability_measures(ss_res))) %>%
  collect() %>%
  unnest(cols = c(stability_measures)) %>%
  saveRDS(here("experiments/checks_puzzles/data/stab_data_1e5_x2x6_factorial.RDS"))
```


## Visualise


```{r}
var_expt1 <- readRDS(here("experiments/9_strains/data/ss_data_1e6_x2x6_factorial.RDS"))
var_expt2 <- readRDS(here("experiments/checks_puzzles/data/ss_data_1e5_x2x6_factorial.RDS"))

p1_short  <- plot_ss_result1(var_expt2,
                result_index = nrow(var_expt2),
                filename_prefix = NULL,
                save_image_file = FALSE)
p1_short

p1_long  <- plot_ss_result1(var_expt1,
                result_index = nrow(var_expt1),
                filename_prefix = NULL,
                save_image_file = FALSE)
p1_long
```


## Continute here to check the stability measures.





# Hidden effect of sulphur bacteria diversity

When the environment ameliorates for the sulphur bacteria, there is no strain replacement (in final state) along the oxygen diffusivity gradient -- either the system is oxic or the least tolerant strain SB9 dominates. And yet the switch to anoxic occurs earlier than when there is no diversity, which suggests there is some role of the more tolerant strains. Indeed Uriah showed that the presence of only the most tolerant strain is sufficient to give an earlier switch, even though it is not present in the final state when less tolerant strains are present. And he showed that the presence of only the least tolerant strain creates a later switch than when there are more tolerant strains.

The explanation is that the most tolerant strain does play a role, but only a transient one. The following dynamics are for the system starting oxic, and with a value of oxygen diffusivity (log10(a_O) = -4.8) for which the system remains oxic if there is no diversity, but switches to anoxic if there is diversity. There is only diversity in the sulphur bacteria. The most tolerant strain does at first grow, but is then outcompeted by less tolerant strains as the environment ameliorates (temporally).

TODO CHECK THE PARAMETER

```{r}
#var_expt <- readRDS(here("experiments/9_strains/data/ss_data_1e6_x2x6_factorial.RDS"))
var_expt_levels <- var_expt[,1:6]
no_diversity <- which(rowSums(abs(var_expt_levels))==0)
max_diversty_all <- which(max(rowSums(abs(var_expt_levels))) ==
                            rowSums(abs(var_expt_levels)))
max_only_CB_diversity <- which(max(rowSums(abs(var_expt_levels[,1:2]))) ==
                            rowSums(abs(var_expt_levels[,1:2])) &
                              rowSums(abs(var_expt_levels[,3:6]))==0)
max_only_SBPB_diversity <- which(max(rowSums(abs(var_expt_levels[,3:6]))) ==
                            rowSums(abs(var_expt_levels[,3:6])) &
                              rowSums(abs(var_expt_levels[,1:2]))==0)
```

```{r eval = eval_dynamics_flag}
parameter <- parameter_master
parameter$strain_parameter <- var_expt[no_diversity,]$pars[[1]]
parameter$sim_duration <- 100000
parameter$result <- NULL
parameter$log10a_series <- c(-4.8, -4.8)
parameter$strain_parameter$initial_state <- new_initial_state(
  nrow(parameter$strain_parameter$CB),
  nrow(parameter$strain_parameter$PB),
  nrow(parameter$strain_parameter$PB),
  values = "bush_ssfig3"
)
parameter$strain_parameter$initial_state[grep("CB_", names(parameter$strain_parameter$initial_state))] <- 10^10/nrow(parameter$strain_parameter$CB)


sim_res_novar1 <- run_simulation(parameter)
saveRDS(sim_res_novar1, here("experiments/checks_puzzles/data/puzzle1_1.RDS"))
```


```{r}
sim_res_novar1 <- readRDS(here("experiments/checks_puzzles/data/puzzle1_1.RDS"))
plot_dynamics(sim_res_novar1)
#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)
```


```{r eval = eval_dynamics_flag}
parameter$strain_parameter <- var_expt[max_only_SBPB_diversity,]$pars[[1]]
#parameter$sim_duration <- 100000
#parameter$result <- NULL
#parameter$log10a_series <- c(-5.2, -5.2)
#parameter$strain_parameter$initial_state <- new_initial_state(
#  nrow(parameter$strain_parameter$CB),
#  nrow(parameter$strain_parameter$PB),
#  nrow(parameter$strain_parameter$PB),
#  values = "bush_ssfig3"
#)
parameter$strain_parameter$initial_state[grep("CB_", names(parameter$strain_parameter$initial_state))] <- 10^10/nrow(parameter$strain_parameter$CB)
sim_res_highvar1 <- run_simulation(parameter)
saveRDS(sim_res_highvar1, here("experiments/checks_puzzles/data/puzzle1_2.RDS"))
```

```{r}
sim_res_highvar1 <- readRDS(here("experiments/checks_puzzles/data/puzzle1_2.RDS"))
plot_dynamics(sim_res_highvar1)
#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)
```


# Zoom in on SS

```{r eval = FALSE, echo = FALSE}
a_Os <- 10^seq(-2.479, -2.4785, length=grid_num_a) ## sequence of a_0 values
initial_CBs <- 1#10^seq(0, 0, length=grid_num_N) ## sequence of N values
initial_PBs <- 1e8 ## not varied
initial_SBs <- 1e8 ## not varied
# next line creates all possible combinations
ss_expt <- expand.grid(N_CB = initial_CBs,
                      N_PB = initial_PBs,
                      N_SB = initial_SBs,
                      a_O = a_Os)
var_expt_master <- var_expt
var_expt <- var_expt_master[381,]
```


```{r, eval = FALSE, echo = FALSE}
#var_expt <- run_ss_var_experiment()
#saveRDS(var_expt, here("experiments/checks_puzzles/data/ss_data_zoom.RDS"))
```


```{r, eval = FALSE, echo = FALSE}
library(here)
zoom <- readRDS(here("experiments/checks_puzzles/data/ss_data_zoom.RDS"))

p1  <- plot_ss_result1(zoom,
                result_index = 1,
                filename_prefix = NULL,
                save_image_file = FALSE)
p1
```








# Negative abundance investigation

I (Owen) found that the sampling interval had an effect on the stability of the simulation. If the sampling interval was long, then in some rare cases (see below) the odesolver failed, with negative abundances occuring. I think this is due to abundances becoming very small, and then the computer having trouble with precision. I guess that when a sample is taken, the abundance is somehow altered if it is very low, probably by some rounding.

```{r eval = FALSE, echo = FALSE}
var_expt$pars[[1]]
dd <- var_expt$ss_res[[1]]
dd1 <- filter(dd, PB_1<(-0.0001))
dd1$a_O

ss_expt_master <- ss_expt
ss_expt <- ss_expt_master[abs(ss_expt_master$a_O - 1.336984e-05)<1e-10,]

var_expt_master <- var_expt
#var_expt <- var_expt[1,]
var_expt_test <- run_ss_var_experiment()
res <- var_expt_test$ss_res[[1]]

test1 <- ss_by_a_N(ss_expt, var_expt$pars[[1]])
x <- ss_expt[2,]
param <- var_expt$pars[[1]]
get_final_states_a_N(x, param)
ssfind_parameters <- param
ssfind_simulation_sampling_interval <- 1000
## now run inside the function "get_final_states_a_N"
simres1 <- simres
ssfind_simulation_sampling_interval <- 5000
## now run inside the function "get_final_states_a_N"
simres2 <- simres  # this fails

## now run inside the function "get_final_states_a_N"
plot_dynamics(simres2)

ggplot() +
  geom_line(data = simres1$result,
             mapping = aes(x = time, y = log10(PB_1))) +
  geom_point(data = simres2$result,
             mapping = aes(x = time, y = log10(PB_1))) +
  xlim(c(0, 250000))

ccc <- simres2$result

simres2$result$PB_1
simres2$result$time


log10_a <- log10(ss_expt$a_O[1]) ## very slowly goes anoxic
#log10_a <- log10(a_Os[354]) ## very slowly goes anoxic
#log10_a <- log10(a_Os[356]) ## very very very  slowly goes anoxic
#log10_a <- log10(a_Os[357]) ## does not go anoxic



default_dynamic_model <- bushplus_dynamic_model
default_event_definition <- event_definition_1
default_event_interval <- ssfind_simulation_duration
default_noise_sigma <- 0
default_minimum_abundances <- ssfind_minimum_abundances
default_sim_duration <- ssfind_simulation_duration
default_sim_sample_interval <- ssfind_simulation_duration
#initial_pars_from <- "bush_ssfig3"


default_log10a_series <- c(log10_a, log10_a)
initial_state <- new_initial_state(num_CB_strains,
                                   num_PB_strains,
                                   num_SB_strains,
                                   values = "bush_ssfig3")
initial_state[grep("CB_", names(initial_state))] <- 10^10/num_CB_strains
sim_res_novar <- run_simulation(parameter_values = var_expt$pars[[1]],
                          initial_state = initial_state)
plot_dynamics(sim_res_novar)

simulation_result <- sim_res_novar
every_n <- 1

chk <- sim_res_novar$result

sim_res_novar$result %>%
  ggplot() +
  geom_line(mapping = aes(x = time, y = PB_1))

#ggsave(here("simulations/expt2/figures/switching_novar.pdf"), width = 10)



```


# Understand about relative and absolute variation in traits

```{r echo = FALSE, eval = FALSE}
num_CB_strains <- 9
num_SB_strains <- 9
num_PB_strains <- 9

## multiplier of SBPB variation
CB_var_multiplier <- 1
SBPB_var_multiplier <- 5

CB_gmax_div <- 0.015789474 * CB_var_multiplier
CB_h_div <- -0.08 * CB_var_multiplier
SB_gmax_div <- 0.015789474 * SBPB_var_multiplier
SB_h_div <- -0.323  * SBPB_var_multiplier
PB_gmax_div <- 0.015789474  * SBPB_var_multiplier
PB_h_div <- -0.323  * SBPB_var_multiplier

num_div_treatment_levels <- 2

var_expt <- create_diversity_factorial(zero = zero, unity = unity, num_div_treatment_levels = num_div_treatment_levels)

display_diversity(
 4,
  var_expt = var_expt,
  num_CB_strains = num_CB_strains,
  num_SB_strains = num_SB_strains,
  num_PB_strains = num_PB_strains
)

this_one <- 4
CBtraits <- var_expt$pars[[this_one]]$CB
P <- 1 #10^seq(-5, 5, 0.1)
SR <- 10^seq(0, 3, 0.1)
gr_rateCB1 <- growth1(P, CBtraits$g_max_CB[1], CBtraits$k_CB_P[1]) * inhibition(SR, CBtraits$h_SR_CB[1])
gr_rateCB9 <- growth1(P, CBtraits$g_max_CB[num_CB_strains], CBtraits$k_CB_P[num_CB_strains]) * inhibition(SR, CBtraits$h_SR_CB[num_CB_strains])
CB_gr_rates <- (c(gr_rateCB1, gr_rateCB9))
CB_gr_range <- max(CB_gr_rates) - min(CB_gr_rates)
CB_gr_range

SBtraits <- var_expt$pars[[this_one]]$SB
P <- 1 #10^seq(-5, 5, 0.1)
SO <- 1
O <- 10^seq(-2.5, 2.5, 0.1)
gr_rateSB1 <- growth2(P, SO, SBtraits$g_max_SB[1], SBtraits$k_SB_P[1], SBtraits$k_SB_SO[1]) *
  inhibition(O, SBtraits$h_O_SB[1])
gr_rateSB9 <- growth2(P, SO, SBtraits$g_max_SB[9], SBtraits$k_SB_P[9], SBtraits$k_SB_SO[9]) *
    inhibition(O, SBtraits$h_O_SB[9])
SB_gr_rates <- (c(gr_rateSB1, gr_rateSB9))
SB_gr_range <- max(SB_gr_rates) - min(SB_gr_rates)
SB_gr_range

PBtraits <- var_expt$pars[[this_one]]$PB
P <- 1 #10^seq(-5, 5, 0.1)
SO <- 1
O <- 10^seq(-2.5, 2.5, 0.1)
gr_ratePB1 <- growth2(P, SO, PBtraits$g_max_PB[1], PBtraits$k_PB_P[1], PBtraits$k_PB_SR[1]) *
  inhibition(O, PBtraits$h_O_PB[1])
gr_ratePB9 <- growth2(P, SO, PBtraits$g_max_PB[9], PBtraits$k_PB_P[9], PBtraits$k_PB_SR[9]) *
  inhibition(O, PBtraits$h_O_PB[9])
PB_gr_rates <- (c(gr_ratePB1, gr_ratePB9))
PB_gr_range <- max(PB_gr_rates) - min(PB_gr_rates)
PB_gr_range

```

<!-- With the CB diversity multiplier set at ` CB_var_multiplier` and the SB/PB multiplier set at ` SBPB_var_multiplier` the range of realised growth rates of CB is ` CB_gr_range`, range of SB is ` SB_gr_range`, and range of PB is ` PB_gr_range`. -->












