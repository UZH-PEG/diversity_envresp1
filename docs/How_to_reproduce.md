---
title: "How to reproduce the research"
format:
  html:
    self-contained: yes
    toc: yes
    toc-location: left
---



TO DO: set package versions everywhere to the one used in the release (1.0.0)

TO DO: delete `old` and other not needed directories (before this we should tag this)

TO DO: Search for XXX for items to update.


# Introduction

Reproducing the research requires: the *microxanox* R package (location given below) and the code to run simulation, analysis, and visualisations in [this repository](https://github.com/UZH-PEG/diversity_envresp1). There is also the option to get the data produced by the simulations (see below), rather than having to produce it by running the simulations (which can take a long time).


# Step 1 -- Get acquainted with the *microxanox* R package

Familarise yourself with the [*microxanox* R package](https://uzh-peg.r-universe.dev/ui#package:microxanox) that was created to facilitate the research. The two vignettes in that package should be useful. The package is also described in this article (link to follow XXX).

## Step 1.1 Get the *microxanox* R package

To reproduce the research, the package `microxanox` version `1.0.0` is needed. **Compatibility with newer versions can not be guaranteed. Of the same main release (1.x.x), compatibility is very likely, with other main releases (2.x.x, 3.x.x, ...) extremely unlikely!**

This repository contains a file called `microxanox_1.0.0.tar.gz` which contains the R package in the correct version.

The R package can be installed by either installing from this file by using


```{r}
remotes::install_local("./microxanox_0.9.0.tar.gz", upgrade = FALSE)
```

You can also install it from the github repository by using

```{r}
remotes::install_github( "UZH-PEG/microxanox", ref = "v0.9.0", build_vignettes = TRUE, upgrade = FALSE)
```

The newest version csan also be installer from the [R-Universe](https://r-universe.dev) as follows:

    install.packages("microxanox", repos = c('https://XXX.r-universe.dev', 'https://cloud.r-project.org'))

To re-iterate: there is a good chance that the versions on the [R-Universe](https://r-universe.dev) are not compatible with the one used in this code!


# Step 2 - Get the repository containing the reproduction code

The code to run simulation, analysis, and visualisations in [this repository](https://github.com/UZH-PEG/diversity_envresp1) from where it can be downloaded. It contains:

1.  `R` -- a folder of containing a file or files of useful R functions. The files are sourced from other scripts; there is no need to directly work with them.
2.  `experiments` -- code for running simulations, processing the data produces, and visualising the results.

A third folder named `data` is created or populated by either running the experiments or downloading the data from a repository (see [below for details](#getting-the-data)). It will contain the data in `.RDS` format readable from R.


# Step 3 - Getting the data

To get the data, you have two options: either run experiments (i.e. simulations) yourself (which takes many days) or use the data as used for the publication **TO DO - publication information**.

The data used is available as a 10GB compressed zip file under the DOI [10.5281/zenodo.6334147](https://doi.org/10.5281/zenodo.6334147) on [Zenodo](https://zenodo.org) (the latest version). This zip file contains the data folder which should be placed in the same directory which contains the folder `R` and `experiments`. Extraction of the zip file will create a folder named `data` in the same directory with the data generated by the scripts in the `experiment` folder.

Ensure that the first folder in this directory is `0_ss_finding` and not `data`.

You can download and extract the data automatically by executing the commands below, which will install the package `zen4R` if not installed yet, download the data package to the working directory (this will take some time, since the file is 10 GB), unzip it, and delete the downloaded file "data.zip":

```{r, eval = FALSE}
if (system.file(package = "zen4R") == "") {
install.packages("zen4R")
}
zen4R::download_zenodo("10.5281/zenodo.6334147")
unzip("data.zip")
rm("data.zip")
```

or with base R:

```{r, eval = FALSE}
# Increase the timeout if it does not download correctly
opt <- options(timeout = 6000)
download.file("https://zenodo.org/record/6334147/files/data.zip?download=1", "data.zip")
options(timeout = opt)

chksum <- tools::md5sum("./data.zip")
if (chksum != "e96386282fb57b58ebeb23b217ac96f6") {
  stop(
    "Checksums are not identical, download likely corrupted!\n",
    "Please try to re-download!\n",
    "If the error persists, try to download from the URL given above!\n",
    "Checksum: ", chksum, "\n",
    "Expected: e96386282fb57b58ebeb23b217ac96f6"
  )
}

unzip("data.zip")
unlink("./data.zip")
```

To understand the structure of the data repository and data files therein please work through the *microxanox* package vignettes, and the various codes in this repository. Of course, please also get in touch with the authors, preferably via submitting and Issue in the github repo.


# Running reproduction scripts

In the text below, the **bold** scripts need to be run, the non-bold are called from the **bold** scripts. The scripts in **bold** need to be executed in the order of their appearance in the subfolders.


## Running simulations and processing data

Beware that running simulations can take a long time (days). All data generated by the scripts and RMarkdown files is contained in the data deposit with the DOI [10.5281/zenodo.6334147](https://doi.org/10.5281/zenodo.6334147). See the section on [Getting the Data](#getting-the-data) to learn how you can get the data, if not done already.

To find stable states by the replication method:

-   `experiments/replication_method` 

    -   `setup_experiment.R`: Setup the experiment including all parameters needed
    -   **`run_experiment.R`**: Run the experiment.
    -   **`data_processing.R`**: Process the data for further processing and analysis.

To find stable states by the temporal method:

-   `experiments/temporal_method`

    -   `check_microxanox_version.R`: Check the version of the installed `microxanox` package.
    -   `setup_experiment.R`: Setup the experiment including all parameters needed
    -   **`run_single_sim.R`**: Run a single simulation.
    -   **`run_experiment.R`**: Run the experiment.
    -   **`data_processing.R`**: Process the data for further processing and analysis.
    -   **`get_div_effects.R`**: Calculate the effects of diversity in each of the combinations of diversity treatments

## Making visualisations and the supplement

To make data-based figures of the research report:

-   **`experiments/1_figures_main_ms/figures_main_ms_v1.R`**

To make the supplementary report:

-   `experiments/2_supplement/supplement.Rmd`: RMarkdown file used to generate the supplement to the publication **XXXTO DO: add publication ref**
    
-   `experiments/3_animate/`

    -   Various code files to make animations of results. `report.RmD` puts the animations together into `report.html`.

